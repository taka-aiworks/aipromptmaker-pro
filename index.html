<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI プロンプトメーカー Pro – 基本情報 / 単語モード / 撮影モード /学習モード / 量産モード / 設定</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="icon" type="image/x-icon" href="image/favicon.ico">

  <meta name="description" content="AIプロンプトメーカー Pro – 初心者でもキャラに統一感を持たせたプロンプトを簡単に生成できるツール。基本情報、単語モード、撮影モード、学習モード、量産モードを搭載。">

  <meta property="og:title" content="AIプロンプトメーカー Pro" />
  <meta property="og:description" content="初心者でもキャラに統一感を持たせたプロンプトを簡単に生成できるWebアプリ" />
  <meta property="og:image" content="image/ogp.png" />

  <!-- ZIP販売用では不要
  <meta property="og:url" content="https://example.com/" />
  -->

  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="AIプロンプトメーカー Pro" />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="AIプロンプトメーカー Pro" />
  <meta name="twitter:description" content="初心者でもキャラに統一感を持たせたプロンプトを簡単に生成できるWebアプリ" />
  <meta name="twitter:image" content="image/ogp.png" />
</head>
<body>
  <div class="header">
    <div class="inner">
      <div class="tabbar">
        <div class="tab active" data-mode="basic">👤 基本情報</div>
        <div class="tab" data-mode="manga">🎨 漫画モード</div>
        <div class="tab" data-mode="word">📖 単語モード</div>
        <div class="tab" data-mode="planner">📷 撮影モード</div>
        <div class="tab" data-mode="learning">🧠 LoRA学習モード</div>
        <div class="tab" data-mode="production">📦 量産モード</div>
        <div class="tab" data-mode="settings">⚙️ 設定</div>
      </div>
      <div class="row mini">
        <span id="status" class="status mini">状態: 内蔵辞書 / 18禁: <b id="nsfwState">OFF</b></span>
      </div>
    </div>
  </div>

    <main class="container">
    <!-- 基本情報 -->
    <section id="panelBasic" class="card">
      <div class="header-row">
        <h2 class="card-title">キャラの基本情報</h2>
        <input type="file" id="importChar" accept="application/json" hidden>
        <label for="importChar" class="btn small">キャラ設定を読み込む</label>
      </div>

      <div class="note mini">
        髪/瞳/肌・髪型・目の形・服・<b>服カラー</b>はここで固定。学習や量産では基本的に変更しません。
      </div>

      <!-- テキスト属性（SFW基礎） -->
      <div class="panel">
        <h2 style="margin-top:18px">テキスト属性（SFW基礎）</h2>
        <!-- 1段目：年齢・性別・体型・身長 -->
        <div class="grid g6" style="margin-top:8px">
          <div class="panel">
            <h3>年齢</h3>
            <div id="bf_age" class="scroller"></div>
          </div>
          <div class="panel">
            <h3>性別</h3>
            <div id="bf_gender" class="scroller"></div>
          </div>
          <div class="panel">
            <h3>体型</h3>
            <div id="bf_body" class="scroller"></div>
          </div>
          <div class="panel">
            <h3>身長</h3>
            <div id="bf_height" class="scroller"></div>
          </div>
          <div class="panel">
            <h3>髪型</h3>
            <div id="hairStyle" class="scroller"></div>
          </div>
          <div class="panel">
          <h3>髪の長さ</h3>
          <div id="hairLength" class="scroller"></div>
        </div>
          <div class="panel">
          <h3>前髪</h3>
          <div id="bangsStyle" class="scroller"></div>
        </div>
        <div class="panel">
          <h3>目の形・特徴</h3>
          <div id="eyeShape" class="scroller"></div>
        </div>
        </div>

      <!-- 色：髪/瞳/肌 -->
      <div class="grid g3" style="margin-top:10px">
        <div class="panel">
          <h3>髪色</h3>
          <div class="wheel-box">
            <div id="wheelH" class="wheel"></div><div id="thumbH" class="thumb"></div>
          </div>
          <label class="row mini">S: <input id="satH" type="range" min="0" max="100" value="70">
            L: <input id="litH" type="range" min="0" max="100" value="45"></label>
          <div class="row mini"><div id="swH" class="swatch"></div>
            <span>タグ: <code class="tag" id="tagH">brown hair</code></span></div>
        </div>

        <div class="panel">
          <h3>瞳色</h3>
          <div class="wheel-box">
            <div id="wheelE" class="wheel"></div><div id="thumbE" class="thumb"></div>
          </div>
          <label class="row mini">S: <input id="satE" type="range" min="0" max="100" value="80">
            L: <input id="litE" type="range" min="0" max="100" value="55"></label>
          <div class="row mini"><div id="swE" class="swatch"></div>
            <span>タグ: <code class="tag" id="tagE">blue eyes</code></span></div>
        </div>

        <div class="panel">
          <h3>肌トーン</h3>
          <input id="skinTone" type="range" min="0" max="100" value="30">
          <div class="row mini"><div id="swSkin" class="swatch"></div>
            <span>タグ: <code class="tag" id="tagSkin">fair skin</code></span></div>
        </div>
          <div class="panel">
          <h3>肌の特徴</h3>
          <div id="skinFeatures" class="scroller"></div>
        </div>
      </div>
    
    <fieldset id="fsSeparates">
      <!-- g3 → g4 に修正して4列対応 -->
      <!-- ▼ outfitMode ラジオ＋wrapper復活：ここで既存の fsSeparates を丸ごと置換 -->
<div class="panel" id="panel_outfitFixed">
  <h3>服（固定 / 上下 or ワンピース）</h3>

  <div class="row mini" style="gap:10px;margin:6px 0 8px">
    <label class="inline">
      <input type="radio" name="outfitMode" value="separate" id="outfitModeSeparate" checked>
      上下コーデ
    </label>
    <label class="inline">
      <input type="radio" name="outfitMode" value="onepiece" id="outfitModeDress">
      ワンピース
    </label>
    <span class="mini">※ ワンピース選択時は「下カラー」は自動で無効</span>
  </div>

  <fieldset id="fsSeparates">
    <!-- g3 → g4 に修正して4列対応（現状維持） -->
    <div class="grid g4">
      <div class="panel">
        <h4 style="margin:0 0 6px">トップス（1つ）</h4>
        <div id="outfit_top" class="scroller"></div>
      </div>

      <div class="panel">
        <h4 style="margin:0 0 6px">ワンピース（1つ）</h4>
        <fieldset id="fsDress" disabled>
          <div id="outfit_dress" class="scroller"></div>
          <div class="mini">選択時は「下カラー」は自動で無効</div>
        </fieldset>
      </div>

      <div class="panel">
        <h4 style="margin:0 0 6px">下カテゴリ</h4>
        <div class="row mini" id="bottomCategoryRadios" style="gap:10px">
          <label class="inline"><input type="radio" name="bottomCat" id="bottomCat_pants" value="pants" checked> ボトムス（ズボン）</label>
          <label class="inline"><input type="radio" name="bottomCat" id="bottomCat_skirt" value="skirt"> スカート</label>
        </div>

        <fieldset id="fsBottom_pants" class="swap-target" style="margin-top:8px">
          <h4 class="mini" style="margin:0 0 6px">ボトムス（ズボン・1つ）</h4>
          <div id="outfit_pants" class="scroller"></div>
        </fieldset>

        <fieldset id="fsBottom_skirt" class="swap-target" style="margin-top:8px">
          <h4 class="mini" style="margin:0 0 6px">スカート（1つ）</h4>
          <div id="outfit_skirt" class="scroller"></div>
        </fieldset>
      </div>

      <!-- 靴（ラジオ選択＋注意書き）※IDはあなたの現状に合わせて維持 -->
      <div class="panel">
        <h4 style="margin:0 0 6px">靴（1つ選択）</h4>
        <div id="outfit_shoes" class="scroller"></div>
        <div class="mini">※ 学習時にはノイズになる可能性があります</div>
      </div>
    </div>
  </fieldset>
</div>
<!-- ▲ outfitMode ラジオ＋wrapper復活：ここまで -->
      <!-- カラー指定（固定） -->
      <div class="card" style="margin-top:10px">
        <h4 style="margin:0 0 6px">服カラー（固定）</h4>
        <div class="mini">トップス / ボトムス / 靴。未操作＝色タグなし。ワンピース選択時は下は無効。</div>

        <div class="grid g3" id="grid_fixed_colors" style="margin-top:8px">
          <div class="panel" id="panel_top">
            <div class="row mini">
              <label class="inline"><input type="checkbox" id="use_top" checked> トップス色を使う</label>
            </div>
            <div class="wheel-box">
              <div id="wheel_top" class="wheel"></div><div id="thumb_top" class="thumb"></div>
            </div>
            <div class="row mini">
              S:<input id="sat_top" type="range" min="0" max="100" value="80">
              L:<input id="lit_top" type="range" min="0" max="100" value="55">
            </div>
            <div class="row mini">
              <div id="sw_top" class="swatch"></div>
              <span>色タグ: <code class="tag" id="tag_top">—</code></span>
            </div>
          </div>

          <div class="panel" id="panel_bottom">
            <div class="row mini">
              <label class="inline"><input type="checkbox" id="useBottomColor" checked> 下カラーを使う（ズボン/スカート共通）</label>
            </div>
            <div class="wheel-box">
              <div id="wheel_bottom" class="wheel"></div><div id="thumb_bottom" class="thumb"></div>
            </div>
            <div class="row mini">
              S:<input id="sat_bottom" type="range" min="0" max="100" value="70">
              L:<input id="lit_bottom" type="range" min="0" max="100" value="50">
            </div>
            <div class="row mini">
              <div id="sw_bottom" class="swatch"></div>
              <span>色タグ: <code class="tag" id="tag_bottom">—</code></span>
            </div>
            <div class="mini">※ ワンピース選択時は自動で無効化されます</div>
          </div>

          <div class="panel" id="panel_shoes">
            <div class="row mini">
              <label class="inline"><input type="checkbox" id="use_shoes"> 靴色を使う</label>
            </div>
            <div class="wheel-box">
              <div id="wheel_shoes" class="wheel"></div><div id="thumb_shoes" class="thumb"></div>
            </div>
            <div class="row mini">
              S:<input id="sat_shoes" type="range" min="0" max="100" value="0">
              L:<input id="lit_shoes" type="range" min="0" max="100" value="30">
            </div>
            <div class="row mini">
              <div id="sw_shoes" class="swatch"></div>
              <span>色タグ: <code class="tag" id="tag_shoes">—</code></span>
            </div>
          </div>
        </div>
      </div>

     <!-- 基本情報タブの適切な位置に追加 -->
      <div class="panel">
        <h3>固定アクセ（キャラ特徴）</h3>
        <div class="mini">メガネ等の恒常特徴のみ。未選択なら挿入しません</div>
        <select id="characterAccessory"></select>
        <div class="wheel-box" style="margin-top:6px">
          <div id="wheel_charAcc" class="wheel"></div>
          <div id="thumb_charAcc" class="thumb"></div>
        </div>
        <div class="row mini">
          S:<input id="sat_charAcc" type="range" min="0" max="100" value="75">
          L:<input id="lit_charAcc" type="range" min="0" max="100" value="50">
        </div>
        <div class="row mini">
          <div id="sw_charAcc" class="swatch"></div>
          <span>色タグ: <code class="tag" id="tag_charAcc">black</code></span>
        </div>
      </div>
      
      
      <div class="panel">
        <h3>キャラ識別</h3>
        <label>キャラ名（seed固定）</label>
        <input id="charName" type="text" placeholder="例: Akari_v1">
        <label style="margin-top:8px">LoRAタグ（任意）</label>
        <input id="loraTag" type="text" placeholder="<lora:YourLoRA:0.8>">
      </div>

      <!-- ▼ 基本情報：1枚テスト（統一版） -->
      <div id="slotBasicOneTest">
        <div class="card" id="learnTestCard">
          <div class="row">
            <div id="readyHint" class="mini muted" style="margin-top:.25rem;"></div>
            <h3 style="margin:0">1枚テスト</h3><span style="flex:1"></span>
            <label class="inline mini">出力フォーマット
              <select id="fmtLearn">
                <option value="a1111" selected>Web UI（汎用）</option>
                <option value="invoke">InvokeAI（CLI）</option>
                <option value="comfy">ComfyUI（テキスト）</option>
                <option value="sdnext">SD.Next（dream.py）</option>
                <option value="nai">NovelAI</option>
              </select>
            </label>
            <button id="btnOneLearn" class="btn ok">テスト生成</button>
            <button id="btnExportChar" class="btn ghost">キャラ設定エクスポート</button>
          </div>
      
          <!-- ★ テキスト（All/Prompt/Neg）だけ表示。テーブルは削除 -->
          <!-- 既存の g3 を g4 に変更 -->
          <div class="grid g4" style="margin-top:10px">
            <div>
              <div class="mini" style="margin:0 0 .35rem">全部</div>
              <div class="out" id="outLearnTestAll"></div>
              <button id="btnCopyLearnTestAll" class="btn ghost small" style="margin-top:6px">全部をコピー</button>
            </div>
            <div>
              <div class="mini" style="margin:0 0 .35rem">Promptのみ</div>
              <div class="out" id="outLearnTestPrompt"></div>
              <button id="btnCopyLearnTestPrompt" class="btn ghost small" style="margin-top:6px">Promptだけコピー</button>
            </div>
            <div>
              <div class="mini" style="margin:0 0 .35rem">Negativeのみ</div>
              <div class="out" id="outLearnTestNeg"></div>
              <button id="btnCopyLearnTestNeg" class="btn ghost small" style="margin-top:6px">Negativeだけコピー</button>
            </div>
            <!-- ★★★ 新規追加：キャプション用の列 ★★★ -->
            <div>
              <div class="mini" style="margin:0 0 .35rem">キャプション用</div>
              <div class="out" id="outLearnTestCaption"></div>
              <button id="btnCopyLearnTestCaption" class="btn ghost small" style="margin-top:6px">キャプションをコピー</button>
            </div>
          </div>
      <!-- ▲ 基本情報：1枚テスト -->
    </section>

<!-- 漫画モードパネル（修正版） -->

<!-- 漫画モードパネル（改善版・統一デザイン） -->
<section id="panelManga" class="card" hidden>
  <div class="manga-mode-header">
    <h2>🎨 漫画モード</h2>
    <!-- 漫画モードパネルの先頭（h2の後）に追加 -->
    <section class="manga-search">
      <div class="manga-search-container">
        <input type="text" id="manga-search-input" placeholder="日本語・英語で検索（部分一致）" class="manga-search-input">
        <button type="button" id="manga-search-clear" class="manga-search-clear">クリア</button>
      </div>
      <div class="manga-search-stats" id="manga-search-stats">全 <span id="manga-total-count">0</span> 件</div>
      
      <!-- 🆕 検索結果表示エリア -->
      <div id="manga-search-results" class="manga-search-results" style="display: none;">
        <div class="manga-search-results-header">
          <span class="manga-search-results-title">検索結果 (<span id="manga-results-count">0</span>件)</span>
          <button type="button" id="manga-results-close" class="manga-results-close">×</button>
        </div>
        <div id="manga-search-results-content" class="manga-search-results-content">
          <!-- 検索結果がここに動的に表示される -->
        </div>
      </div>
    </section>
    <div class="manga-priority-note">
      ※ 上から選ぶほど意味が強くなります。競合する場合はNSFW設定が優先されます。
    </div>
  </div>

  <!-- 1) キャラ基礎使用方式（1人目用・簡略化） -->
  <div class="manga-params-section">
    <div class="row" style="align-items: center; margin-bottom: 12px;">
      <h3 style="margin: 0;">1. キャラ基礎使用方式（1人目）</h3>
    </div>
    
    <div class="char-base-options">
      <label class="inline">
        <input type="radio" name="mangaCharBase" value="B" checked>
        基本情報で設定した内容をそのまま使う（推奨）
      </label>
      <label class="inline">
        <input type="radio" name="mangaCharBase" value="C">
        使わない（完全自由）
      </label>
    </div>
    
    <div class="char-base-note">
      💡 「コア＋服を使う」を選択すると、基本情報タブで設定した内容（性別・年齢・髪型・髪色・瞳色・肌色・服装・服の色）が自動適用されます。<br>
    </div>
  </div>

  <div class="manga-section-divider"></div>

  <!-- 2) LoRA設定 -->
  <div class="manga-params-section">
    <div class="row" style="align-items: center; margin-bottom: 12px;">
      <h3 style="margin: 0;">2. LoRA設定（任意）</h3>
      <label class="inline" style="margin-left: 16px;">
        <input type="checkbox" id="mangaUseLoRA">
        LoRAを使う
      </label>
    </div>
    
    <div id="loraContent" class="lora-content" style="display: none;">
      <div style="margin-top: 12px;">
        <label>LoRAタグ</label>
        <input type="text" id="mangaLoRATag" placeholder="<lora:__________:0.8>">
        
        <div class="lora-weight-control">
          <span class="mini">重み:</span>
          <input type="range" id="mangaLoRAWeight" min="0.4" max="1.2" step="0.1" value="0.8">
          <span class="weight-value" id="mangaLoRAWeightValue">0.8</span>
        </div>
        
        <div class="note mini" style="margin-top: 8px;">
          うまく効かない時は重み↓ or 基礎タグ弱め（例：(orange hair:0.7)）
        </div>
      </div>
    </div>
  </div>

  <div class="manga-section-divider"></div>

  <!-- 3) 漫画パラメータ（SFW）- 統一デザインで開閉可能 -->
  <div class="manga-params-section">
    <div class="row" style="align-items: center; margin-bottom: 12px;">
      <h3 style="margin: 0;">3. 漫画パラメータ（SFW）</h3>
      <label class="inline" style="margin-left: 16px;">
        <input type="checkbox" id="mangaSFWParamsToggle" checked>
        パラメータを表示
      </label>
    </div>
    
    <div id="mangaSFWParamsContent" style="display: block;">
      <div style="margin-top: 12px;">
        
        <!-- 感情（必須に近い） -->
        <div style="margin-bottom: 16px;">
          <h4 class="mini">感情（必須に近い）- ラジオ（単一）</h4>
          <div id="mangaEmotionPrimary" class="scroller"></div>
          
          <h5 class="mini" style="margin-top: 8px;">サブ感情 - ラジオ（単一推奨）</h5>
          <div id="mangaEmotionDetail" class="scroller"></div>
        </div>
        
        <!-- 表情（顔の基本） -->
        <div style="margin-bottom: 16px;">
          <h4 class="mini">表情（顔の基本）- ラジオ（単一）</h4>
          <div id="mangaExpressions" class="scroller"></div>
        </div>
        
        <!-- 補助表情（顔の効果） -->
        <div style="margin-bottom: 16px;">
          <h4 class="mini">補助表情（顔の効果）- チェック（複数・推奨上限2〜3）</h4>
          <div id="mangaEffectManga" class="scroller"></div>
        </div>
        
        <!-- 目（Eye detail） -->
        <div style="margin-bottom: 16px;">
          <h4 class="mini">目（Eye detail）- ラジオ（単一）</h4>
          <div class="grid g2">
            <div>
              <label class="mini">目の状態</label>
              <div id="mangaEyeState" class="scroller"></div>
            </div>
            <div>
              <label class="mini">視線方向</label>
              <div id="mangaGaze" class="scroller"></div>
            </div>
          </div>
        </div>
        
        <!-- 口（Mouth detail） -->
        <div style="margin-bottom: 16px;">
          <h4 class="mini">口（Mouth detail）- ラジオ（単一）</h4>
          <div id="mangaMouthState" class="scroller"></div>
        </div>
        
        <!-- ポーズ -->
        <div style="margin-bottom: 16px;">
          <h4 class="mini">ポーズ（Pose）- ラジオ（単一）</h4>
          <div id="mangaPose" class="scroller"></div>
        </div>
        
        <!-- アクション -->
        <div style="margin-bottom: 16px;">
          <h4 class="mini">アクション（Action）- チェック（複数・推奨1〜2）</h4>
          <div class="grid g2">
            <div>
              <label class="mini">手のジェスチャー</label>
              <div id="mangaHandGesture" class="scroller"></div>
            </div>
            <div>
              <label class="mini">動作</label>
              <div id="mangaMovementAction" class="scroller"></div>
            </div>
          </div>
        </div>
        
        <!-- 構図 -->
        <div style="margin-bottom: 16px;">
          <h4 class="mini">構図（Framing / 体の入れ方）- ラジオ（単一）</h4>
          <div id="mangaComposition" class="scroller"></div>
        </div>
        
        <!-- 体の向き -->
        <div style="margin-bottom: 16px;">
          <h4 class="mini">体の向き（Orientation）- ラジオ（単一）</h4>
          <div id="mangaView" class="scroller"></div>
        </div>
        
        <!-- カメラワーク -->
        <div style="margin-bottom: 16px;">
          <h4 class="mini">カメラワーク（View / Angle）- ラジオ（単一）</h4>
          <div id="mangaCameraView" class="scroller"></div>
        </div>
        
        <!-- 小物（軽） -->
        <div style="margin-bottom: 16px;">
          <h4 class="mini">小物（軽）- チェック（複数・0〜2推奨）</h4>
          <div id="mangaPropsLight" class="scroller"></div>
        </div>
        
        <!-- 効果演出 -->
        <div style="margin-bottom: 16px;">
          <h4 class="mini">効果演出（Comic FX）- チェック（複数・0〜2推奨）</h4>
          <div id="mangaEffectMangaFX" class="scroller"></div>
        </div>
        
        <!-- 任意項目（折りたたみ） -->
        <div class="manga-optional-section">
          <div class="row" style="align-items: center; margin-bottom: 12px;">
            <h4 style="margin: 0;" class="mini">任意項目（背景・ライティング・画風）</h4>
            <label class="inline" style="margin-left: 16px;">
              <input type="checkbox" id="mangaOptionalToggle">
              オプション項目を表示
            </label>
          </div>
          
          <div id="mangaOptionalContent" style="display: none;">
            <div style="margin-top: 12px;">
              <div class="grid g3">
                <div>
                  <label class="mini">背景 - ラジオ（単一）</label>
                  <div id="mangaBackground" class="scroller"></div>
                </div>
                <div>
                  <label class="mini">ライティング - ラジオ（単一）</label>
                  <div id="mangaLighting" class="scroller"></div>
                </div>
                <div>
                  <label class="mini">画風 - ラジオ（単一）</label>
                  <div id="mangaArtStyle" class="scroller"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="manga-section-divider"></div>

  <!-- 4) NSFW -->
  <div class="manga-params-section">
    <div class="row" style="align-items: center; margin-bottom: 12px;">
      <h3 style="margin: 0;">4. NSFW（任意・初期閉／デフォOFF）</h3>
      <label class="inline" style="margin-left: 16px;">
        <input type="checkbox" id="mangaNSFWEnable">
        NSFWを有効化
      </label>
    </div>
    
    <div id="mangaNSFWPanel" style="display: none;">
      <div class="note mini" style="margin-bottom: 12px;">
        NSFWカテゴリ（ON時のみ表示、合成時はNSFW優先）
      </div>
      
      <div class="grid g3">
        <!-- 🆕 人数カテゴリ -->
      <div>
        <label class="mini">人数・構成 - ラジオ（単一）</label>
        <div id="mangaNSFWParticipants" class="scroller"></div>
      </div>
        <div>
          <label class="mini">NSFW表情 - ラジオ（単一）</label>
          <div id="mangaNSFWExpr" class="scroller"></div>
        </div>
        <div>
          <label class="mini">露出度 - ラジオ（単一）</label>
          <div id="mangaNSFWExpo" class="scroller"></div>
        </div>
        <div>
          <label class="mini">シチュ - ラジオ（単一）</label>
          <div id="mangaNSFWSitu" class="scroller"></div>
        </div>
        <div>
          <label class="mini">照明/ムード - ラジオ（単一）</label>
          <div id="mangaNSFWLight" class="scroller"></div>
        </div>
        <div>
          <label class="mini">NSFWポーズ - ラジオ（単一）</label>
          <div id="mangaNSFWPose" class="scroller"></div>
        </div>
        <div>
          <label class="mini">NSFWアクション - チェック（複数・上限2推奨）</label>
          <div id="mangaNSFWAction" class="scroller"></div>
        </div>
        <!-- 🔧 修正：射精・体液系アクション -->  
        <div>
          <label class="mini">射精・体液系 - チェック（複数・上限2推奨）</label>
          <div id="mangaNSFWAction2" class="scroller"></div>
        </div>
        <div>
          <label class="mini">小物/アクセ - チェック（複数）</label>
          <div id="mangaNSFWAcc" class="scroller"></div>
        </div>
        <div>
          <label class="mini">衣装系 - ラジオ（単一）</label>
          <div id="mangaNSFWOutfit" class="scroller"></div>
        </div>
        <div>
          <label class="mini">体表/体勢のNSFW属性 - チェック（複数）</label>
          <div id="mangaNSFWBody" class="scroller"></div>
        </div>
        <div>
          <label class="mini">乳首表現 - ラジオ（単一）</label>
          <div id="mangaNSFWNipples" class="scroller"></div>
        </div>
        <div>
          <label class="mini">下着状態 - ラジオ（単一）</label>
          <div id="mangaNSFWUnderwear" class="scroller"></div>
        </div>
      </div>
      
      <div class="note mini" style="margin-top: 12px;">
        <strong>NSFW優先ロジック：</strong><br>
        pose vs n_pose、action vs n_action、expressions vs n_expr など対立はNSFWを採用。<br>
        露出・衣装は n_outfit/n_expo をSFWの服より優先。
      </div>
    </div>
  </div>

  <div class="manga-section-divider"></div>

  <!-- 5) 2人目キャラ -->
  <div class="manga-params-section">
    <div class="row" style="align-items: center; margin-bottom: 12px;">
      <h3 style="margin: 0;">5. 2人目キャラ（任意）</h3>
      <label class="inline" style="margin-left: 16px;">
        <input type="checkbox" id="mangaSecondCharEnable">
        2人目を追加する
      </label>
    </div>
    
    <div id="secondCharContent" class="second-char-content" style="display: none;">
      <!-- 2人目のインポート/エクスポートボタン -->
      <div class="second-char-io" style="margin-bottom: 16px; padding: 12px; border: 1px dashed var(--line); border-radius: 8px;">
        <div class="row" style="align-items: center; gap: 8px;">
          <h4 style="margin: 0;">2人目キャラ設定</h4>
          <input type="file" id="importSecondChar" accept="application/json" hidden>
          <label for="importSecondChar" class="btn small">設定を読み込む</label>
          <button id="btnExportSecondChar" class="btn ghost small">設定をエクスポート</button>
        </div>
      </div>
      
      <!-- LoRA設定 -->
      <div style="margin-bottom: 16px;">
        <h4 class="mini">LoRA（任意）</h4>
        <label class="inline">
          <input type="checkbox" id="secondCharUseLoRA">
          LoRAを使う
        </label>
        <div id="secondCharLoRAPanel" style="display: none; margin-top: 8px;">
          <input type="text" id="secondCharLoRATag" placeholder="<lora:__________:0.8>">
          <div class="lora-weight-control">
            <span class="mini">重み:</span>
            <input type="range" id="secondCharLoRAWeight" min="0.4" max="1.2" step="0.1" value="0.8">
            <span class="weight-value" id="secondCharLoRAWeightValue">0.8</span>
          </div>
        </div>
      </div>
      
      <!-- キャラ基礎使用方式（2人目用） -->
      <div style="margin-bottom: 16px;">
        <h4 class="mini">キャラ基礎使用方式</h4>
        <div class="char-base-options">
          <label class="inline">
            <input type="radio" name="secondCharBase" value="B" checked>
            コア＋服を使う
          </label>
          <label class="inline">
            <input type="radio" name="secondCharBase" value="C">
            使わない（完全自由）
          </label>
        </div>
      </div>
      
      <!-- コア設定（B選択時・2人目用） -->
      <div id="secondCharCorePanel" class="second-char-details" style="display: none;">
        <h4 style="margin: 0 0 12px 0;">コア固定設定（2人目専用）</h4>
        
        <div class="second-char-grid">
          <div>
            <label class="mini">性別</label>
            <div id="secondCharGender" class="scroller"></div>
          </div>
          <div>
            <label class="mini">年齢</label>
            <div id="secondCharAge" class="scroller"></div>
          </div>
          <div>
            <label class="mini">髪型</label>
            <div id="secondCharHairstyle" class="scroller"></div>
          </div>
          <div>
            <label class="mini">髪色</label>
            <div id="secondCharHairColor" class="scroller"></div>
          </div>
          <div>
            <label class="mini">瞳色</label>
            <div id="secondCharEyeColor" class="scroller"></div>
          </div>
          <div>
            <label class="mini">肌色</label>
            <div id="secondCharSkinTone" class="scroller"></div>
          </div>
        </div>
        
        <h4 style="margin: 16px 0 8px 0;">服固定設定（2人目専用）</h4>
        
        <div class="second-char-grid">
          <div>
            <label class="mini">トップス</label>
            <div id="secondCharTop" class="scroller"></div>
          </div>
          <div>
            <label class="mini">ボトムス</label>
            <div id="secondCharBottom" class="scroller"></div>
          </div>
          <div>
            <label class="mini">ドレス</label>
            <div id="secondCharDress" class="scroller"></div>
          </div>
          <div>
            <label class="mini">靴</label>
            <div id="secondCharShoes" class="scroller"></div>
          </div>
        </div>
        
        <h4 style="margin: 16px 0 8px 0;">色固定設定（2人目専用）</h4>
        <div class="second-char-colors">
          <div class="color-picker-item">
            <label>トップス色</label>
            <div class="wheel-box">
              <div id="wheel_secondTop" class="wheel"></div>
              <div id="thumb_secondTop" class="thumb"></div>
            </div>
            <div class="row mini">
              S: <input id="sat_secondTop" type="range" min="0" max="100" value="0">
              L: <input id="lit_secondTop" type="range" min="0" max="100" value="90">
            </div>
            <div class="row mini">
              <div id="sw_secondTop" class="swatch"></div>
              <span>色: <code id="tag_secondTop" class="tag">white</code></span>
            </div>
          </div>
          
          <div class="color-picker-item">
            <label>ボトムス色</label>
            <div class="wheel-box">
              <div id="wheel_secondBottom" class="wheel"></div>
              <div id="thumb_secondBottom" class="thumb"></div>
            </div>
            <div class="row mini">
              S: <input id="sat_secondBottom" type="range" min="0" max="100" value="80">
              L: <input id="lit_secondBottom" type="range" min="0" max="100" value="50">
            </div>
            <div class="row mini">
              <div id="sw_secondBottom" class="swatch"></div>
              <span>色: <code id="tag_secondBottom" class="tag">blue</code></span>
            </div>
          </div>
          
          <div class="color-picker-item">
            <label>靴色</label>
            <div class="wheel-box">
              <div id="wheel_secondShoes" class="wheel"></div>
              <div id="thumb_secondShoes" class="thumb"></div>
            </div>
            <div class="row mini">
              S: <input id="sat_secondShoes" type="range" min="0" max="100" value="0">
              L: <input id="lit_secondShoes" type="range" min="0" max="100" value="50">
            </div>
            <div class="row mini">
              <div id="sw_secondShoes" class="swatch"></div>
              <span>色: <code id="tag_secondShoes" class="tag">gray</code></span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 2人目のパラメータ設定 -->
      <!-- インタラクション -->
      <div class="interaction-section">
        <h4 class="mini">インタラクション（何をするか）</h4>
        
        <!-- SFW/NSFW切り替えラジオボタン -->
        <div class="row mini" style="gap: 12px; margin: 8px 0;">
          <label class="inline">
            <input type="radio" name="interactionMode" value="sfw" checked>
            SFWインタラクション
          </label>
          <label class="inline">
            <input type="radio" name="interactionMode" value="nsfw">
            NSFWインタラクション
          </label>
        </div>
        
        <!-- SFWインタラクション -->
        <div id="sfwInteractionPanel">
          <div id="secondCharInteractionSFW" class="scroller"></div>
        </div>
        
        <!-- NSFWインタラクション -->
        <div id="nsfwInteractionPanel" style="display: none;">
          <div id="secondCharInteractionNSFW" class="scroller"></div>
        </div>
        
        <div class="note mini" style="margin-top: 8px;">
          <strong>インタラクション優先順位：</strong>interaction > n_pose/pose > n_action/action<br>
          二人の位置/ポーズ/アクションに矛盾が出ないよう調整されます
        </div>
      </div>
    </div>
  </div>

  <div class="manga-section-divider"></div>

  <!-- 6) ネガティブプロンプト（改良版） -->
<div class="manga-params-section">
  <div class="row" style="align-items: center; margin-bottom: 12px;">
    <h3 style="margin: 0;">6. ネガティブプロンプト</h3>
  </div>
  
  <!-- クイックプリセット（ワンクリック選択） -->
  <div style="margin-bottom: 16px;">
    <h4 class="mini">クイックプリセット（ワンクリック選択）</h4>
    <div class="row" style="gap: 8px; margin-top: 8px;">
      <button type="button" class="btn ghost small" id="negQuickLight">軽量セット</button>
      <button type="button" class="btn ghost small" id="negQuickStandard">標準セット</button>
      <button type="button" class="btn ghost small" id="negQuickHigh">高品質セット</button>
      <button type="button" class="btn ghost small" id="negQuickManga">漫画特化セット</button>
      <button type="button" class="btn bad small" id="negClearAll">全解除</button>
    </div>
    <div class="note mini" style="margin-top: 6px;">
      プリセットを選択すると下記のカテゴリ別選択が自動で設定されます
    </div>
  </div>
  
  <!-- カテゴリ別詳細選択 -->
  <div style="margin-bottom: 16px;">
    <h4 class="mini">カテゴリ別詳細選択（チェック・複数可）</h4>
    
    <!-- 必須・推奨カテゴリ -->
    <div style="margin-bottom: 12px;">
      <h5 class="mini" style="color: var(--accent-ok);">必須・推奨（基本品質とアナトミー）</h5>
      <div id="mangaNegEssential" class="scroller"></div>
    </div>
    
    <!-- 任意カテゴリ（折りたたみ可能） -->
    <details>
      <summary class="mini" style="cursor: pointer; margin-bottom: 8px;">
        <span class="caret">▶</span> 任意カテゴリ（追加で選択）
      </summary>
      
      <div class="grid g2" style="margin-top: 12px; gap: 16px;">
        <div>
          <h5 class="mini">品質向上</h5>
          <div id="mangaNegQuality" class="scroller"></div>
        </div>
        <div>
          <h5 class="mini">不要素除去</h5>
          <div id="mangaNegUnwanted" class="scroller"></div>
        </div>
        <div>
          <h5 class="mini">顔・表情</h5>
          <div id="mangaNegFace" class="scroller"></div>
        </div>
        <div>
          <h5 class="mini">身体・解剖</h5>
          <div id="mangaNegBody" class="scroller"></div>
        </div>
        <div>
          <h5 class="mini">画風維持</h5>
          <div id="mangaNegStyle" class="scroller"></div>
        </div>
        <div>
          <h5 class="mini">構図改善</h5>
          <div id="mangaNegComposition" class="scroller"></div>
        </div>
        <div>
          <h5 class="mini">服装</h5>
          <div id="mangaNegClothing" class="scroller"></div>
        </div>
      </div>
    </details>
  </div>
  
  <!-- カスタム追記 -->
  <div>
    <label>カスタム追記（自由入力）</label>
    <textarea id="mangaNegativeCustom" rows="3" placeholder="追加のネガティブプロンプトを入力（カンマ区切り）"></textarea>
    <div class="note mini">
      出力順（推奨）：プリセット → カスタム<br>
      例: bad hands, low quality, my custom negative
    </div>
  </div>
  
  <!-- 現在の選択状況 -->
  <div style="margin-top: 12px; padding: 8px; background: rgba(100,150,255,0.1); border-radius: 6px;">
    <div class="mini" style="margin-bottom: 6px;">現在の選択状況:</div>
    <div class="mini" id="negativePreview" style="word-break: break-all; opacity: 0.8;">
      未選択
    </div>
  </div>
</div>

  <div class="manga-section-divider"></div>

  <!-- 7) 固定タグ -->
  <div class="manga-params-section">
    <div class="row" style="align-items: center; margin-bottom: 12px;">
      <h3 style="margin: 0;">7. 固定タグ</h3>
    </div>
    
    <label>固定タグ（先頭に付与）</label>
    <textarea id="fixedManga" rows="3" placeholder="※タグを追加したい場合はここに入力"></textarea>
    <div class="note mini">出力時に最初に配置されます</div>
  </div>

 <!-- 8) 商用利用可能LoRA（新規追加） -->
<div class="manga-params-section">
  <div class="row" style="align-items: center; margin-bottom: 12px;">
    <h3 style="margin: 0;">8. 商用利用可能LoRA（複数選択可）</h3>
    <label class="inline" style="margin-left: 16px;">
      <input type="checkbox" id="mangaCommercialLoRAEnable">
      商用LoRAを有効化
    </label>
  </div>
  
  <div id="commercialLoRAPanel" style="display: none;">
    <div class="note mini" style="margin-bottom: 12px; padding: 8px; background: rgba(34, 197, 94, 0.1); border-left: 3px solid #22c55e; border-radius: 4px;">
      ✅ <strong>商用利用可能</strong>なLoRAのみを収録しています。<br>
      複数選択可能で、選択したLoRAが自動的にプロンプトに追加されます。
    </div>
    
    <!-- カテゴリ別タブ -->
    <div class="commercial-lora-tabs">
      <div class="tab-buttons" style="display: flex; gap: 4px; margin-bottom: 12px;">
        <button type="button" class="lora-tab-btn active" data-category="all">全て</button>
        <button type="button" class="lora-tab-btn" data-category="style">画風</button>
        <button type="button" class="lora-tab-btn" data-category="quality">品質</button>
        <button type="button" class="lora-tab-btn" data-category="expression">表現</button>
        <button type="button" class="lora-tab-btn" data-category="background">背景</button>
        <button type="button" class="lora-tab-btn" data-category="lighting">照明</button>
      </div>
      
      <!-- 全解除ボタン -->
      <div style="margin-bottom: 12px;">
        <button type="button" class="btn bad small" id="clearAllCommercialLoRA">全解除</button>
        <span class="mini" style="margin-left: 12px;">
          選択中: <span id="selectedLoRACount">0</span>個
        </span>
      </div>
      
      <!-- LoRAアイテム表示エリア -->
      <div id="commercialLoRAItems" class="commercial-lora-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px;">
        <!-- JavaScriptで動的生成 -->
      </div>
      
      <!-- 重み一括調整 -->
      <div style="margin-top: 16px; padding: 12px; border: 1px solid var(--line); border-radius: 6px;">
        <h4 style="margin: 0 0 8px 0;" class="mini">重み一括調整（選択中のLoRAに適用）</h4>
        <div class="row" style="align-items: center; gap: 12px;">
          <span class="mini">弱</span>
          <input type="range" id="bulkLoRAWeight" min="0.2" max="1.5" step="0.1" value="0.8" style="flex: 1;">
          <span class="mini">強</span>
          <span class="weight-value" id="bulkLoRAWeightValue">0.8</span>
          <button type="button" class="btn ghost small" id="applyBulkWeight">一括適用</button>
        </div>
        <div class="note mini" style="margin-top: 6px;">
          選択中のLoRAすべてに同じ重みを適用します
        </div>
      </div>
    </div>
  </div>
</div>

  
  <!-- 8) 出力エリア -->
  <div class="manga-output">
    <div id="conflictWarning" class="conflict-warning" style="display: none;">
      ⚠️ 設定に競合があります：NSFWが優先されます
    </div>
    
    <div class="row" style="gap: 8px; margin-top: 10px;">
      <button id="btnMangaGenerate" class="btn ok">プロンプト生成</button>
      <label class="inline mini">出力フォーマット
        <select id="fmtManga">
          <option value="a1111" selected>Web UI（汎用）</option>
          <option value="invoke">InvokeAI（CLI）</option>
          <option value="comfy">ComfyUI（テキスト）</option>
          <option value="sdnext">SD.Next（dream.py）</option>
          <option value="nai">NovelAI</option>
        </select>
      </label>
      <div class="row mini" style="margin-left: auto;">
        <label class="inline">
          <input type="checkbox" id="mangaFixedSeed">
          seed固定
        </label>
        <label class="inline">
          <input type="checkbox" id="mangaMicroDiff">
          微差スイッチ
        </label>
        <span>seed: <span id="mangaSeedValue">1234567890</span></span>
      </div>
    </div>
    
    <div class="grid g3" style="margin-top: 10px;">
      <div>
        <div class="mini" style="margin: 0 0 .35rem">全部</div>
        <div class="out" id="outMangaAll"></div>
        <button id="btnCopyMangaAll" class="btn ghost small" style="margin-top: 6px;">全部をコピー</button>
      </div>
      <div>
        <div class="mini" style="margin: 0 0 .35rem">Promptのみ</div>
        <div class="out" id="outMangaPrompt"></div>
        <button id="btnCopyMangaPrompt" class="btn ghost small" style="margin-top: 6px;">Promptだけコピー</button>
      </div>
      <div>
        <div class="mini" style="margin: 0 0 .35rem">Negativeのみ</div>
        <div class="out" id="outMangaNeg"></div>
        <button id="btnCopyMangaNeg" class="btn ghost small" style="margin-top: 6px;">Negativeだけコピー</button>
      </div>
    </div>
  </div>
</section>
          
<!-- ======================= 単語モード：パネル本体 ======================= -->
<section id="panelWordMode" class="card" hidden>
  <header class="wm-header">
    <!-- ここから先は、あなたが用意した単語モードの中身を置いてOK -->
    <h2>単語モード</h2>
    <p class="wm-note">
      辞書からカテゴリ別に単語を選び、下部テーブルに最大20件まで蓄積・コピーできます。
      表示は <strong>日本語（大）</strong>＋<small>英語（小）</small> で統一。
    </p>
  </header>

   <!-- ★★★ 検索機能を追加 ★★★ -->
  <section class="wm-search">
    <div class="wm-search-container">
      <input type="text" id="wm-search-input" placeholder="日本語・英語で検索（部分一致）" class="wm-search-input">
      <button type="button" id="wm-search-clear" class="wm-search-clear">×</button>
    </div>
    <div class="wm-search-stats" id="wm-search-stats">全 <span id="wm-total-count">0</span> 件</div>
  </section>

  <!-- 選択中バー（選択チップを並べる） -->
  <section class="wm-selected">
    <div class="wm-selected-head">
      <strong>選択中 <span id="wm-selected-count">0</span>/20</strong>
      <div class="wm-selected-actions">
        <button id="wm-selected-clear" type="button" aria-label="全クリア">Clear</button>
      </div>
    </div>
    <div id="wm-selected-chips" class="wm-chip-area" aria-live="polite"></div>
  </section>

  <!-- ========== アコーディオン（SFW） ========== -->
  
  <section class="wm-accordion" id="wm-accordion-sfw">
    <h3 class="wm-acc-title">SFW</h3>

    <!-- 既存項目 -->
    <details class="wm-acc" data-cat="background">
      <summary>背景 <span class="wm-count" id="wm-count-background">0</span></summary>
      <div class="wm-items" id="wm-items-background"></div>
    </details>

    <details class="wm-acc" data-cat="pose">
      <summary>ポーズ <span class="wm-count" id="wm-count-pose">0</span></summary>
      <div class="wm-items" id="wm-items-pose"></div>
    </details>

    <details class="wm-acc" data-cat="composition">
      <summary>構図 <span class="wm-count" id="wm-count-composition">0</span></summary>
      <div class="wm-items" id="wm-items-composition"></div>
    </details>

    <details class="wm-acc" data-cat="view">
      <summary>視点 <span class="wm-count" id="wm-count-view">0</span></summary>
      <div class="wm-items" id="wm-items-view"></div>
    </details>

    <details class="wm-acc" data-cat="expression-sfw">
      <summary>表情（SFW） <span class="wm-count" id="wm-count-expression-sfw">0</span></summary>
      <div class="wm-items" id="wm-items-expression-sfw"></div>
    </details>

    <details class="wm-acc" data-cat="lighting-sfw">
      <summary>ライティング（SFW） <span class="wm-count" id="wm-count-lighting-sfw">0</span></summary>
      <div class="wm-items" id="wm-items-lighting-sfw"></div>
    </details>

    <details class="wm-acc" data-cat="worldview">
      <summary>世界観 <span class="wm-count" id="wm-count-worldview">0</span></summary>
      <div class="wm-items" id="wm-items-worldview"></div>
    </details>

    <details class="wm-acc" data-cat="accessories">
      <summary>アクセサリー <span class="wm-count" id="wm-count-accessories">0</span></summary>
      <div class="wm-items" id="wm-items-accessories"></div>
    </details>

    <details class="wm-acc" data-cat="age">
      <summary>年齢 <span class="wm-count" id="wm-count-age">0</span></summary>
      <div class="wm-items" id="wm-items-age"></div>
    </details>

    <details class="wm-acc" data-cat="gender">
      <summary>性別 <span class="wm-count" id="wm-count-gender">0</span></summary>
      <div class="wm-items" id="wm-items-gender"></div>
    </details>

    <details class="wm-acc" data-cat="body-type">
      <summary>体型 <span class="wm-count" id="wm-count-body-type">0</span></summary>
      <div class="wm-items" id="wm-items-body-type"></div>
    </details>

    <details class="wm-acc" data-cat="height">
      <summary>身長 <span class="wm-count" id="wm-count-height">0</span></summary>
      <div class="wm-items" id="wm-items-height"></div>
    </details>

    <details class="wm-acc" data-cat="hair-style">
      <summary>髪型 <span class="wm-count" id="wm-count-hair-style">0</span></summary>
      <div class="wm-items" id="wm-items-hair-style"></div>
    </details>

    <details class="wm-acc" data-cat="hair-length">
      <summary>髪の長さ <span class="wm-count" id="wm-count-hair-length">0</span></summary>
      <div class="wm-items" id="wm-items-hair-length"></div>
    </details>

    <details class="wm-acc" data-cat="bangs-style">
      <summary>前髪 <span class="wm-count" id="wm-count-bangs-style">0</span></summary>
      <div class="wm-items" id="wm-items-bangs-style"></div>
    </details>

    <details class="wm-acc" data-cat="skin-features">
      <summary>肌の特徴 <span class="wm-count" id="wm-count-skin-features">0</span></summary>
      <div class="wm-items" id="wm-items-skin-features"></div>
    </details>

    <details class="wm-acc" data-cat="eyes">
      <summary>目の形 <span class="wm-count" id="wm-count-eyes">0</span></summary>
      <div class="wm-items" id="wm-items-eyes"></div>
    </details>

    <details class="wm-acc" data-cat="face">
      <summary>顔の特徴 <span class="wm-count" id="wm-count-face">0</span></summary>
      <div class="wm-items" id="wm-items-face"></div>
    </details>

    <details class="wm-acc" data-cat="outfit-sfw">
      <summary>服（SFW） <span class="wm-count" id="wm-count-outfit-sfw">0</span></summary>
      <div class="wm-items" id="wm-items-outfit-sfw"></div>
    </details>

    <details class="wm-acc" data-cat="art-style">
      <summary>画風 <span class="wm-count" id="wm-count-art-style">0</span></summary>
      <div class="wm-items" id="wm-items-art-style"></div>
    </details>

    <details class="wm-acc" data-cat="emotion-primary">
      <summary>基本感情 <span class="wm-count" id="wm-count-emotion-primary">0</span></summary>
      <div class="wm-items" id="wm-items-emotion-primary"></div>
    </details>

    <details class="wm-acc" data-cat="emotion-detail">
      <summary>詳細感情 <span class="wm-count" id="wm-count-emotion-detail">0</span></summary>
      <div class="wm-items" id="wm-items-emotion-detail"></div>
    </details>

    <details class="wm-acc" data-cat="mouth-state">
      <summary>口の状態 <span class="wm-count" id="wm-count-mouth-state">0</span></summary>
      <div class="wm-items" id="wm-items-mouth-state"></div>
    </details>

    <details class="wm-acc" data-cat="eye-state">
      <summary>目の状態 <span class="wm-count" id="wm-count-eye-state">0</span></summary>
      <div class="wm-items" id="wm-items-eye-state"></div>
    </details>

    <details class="wm-acc" data-cat="gaze">
      <summary>視線方向 <span class="wm-count" id="wm-count-gaze">0</span></summary>
      <div class="wm-items" id="wm-items-gaze"></div>
    </details>

    <details class="wm-acc" data-cat="pose-manga">
      <summary>漫画ポーズ <span class="wm-count" id="wm-count-pose-manga">0</span></summary>
      <div class="wm-items" id="wm-items-pose-manga"></div>
    </details>

    <details class="wm-acc" data-cat="hand-gesture">
      <summary>手のジェスチャー <span class="wm-count" id="wm-count-hand-gesture">0</span></summary>
      <div class="wm-items" id="wm-items-hand-gesture"></div>
    </details>

    <details class="wm-acc" data-cat="props-light">
      <summary>小物 <span class="wm-count" id="wm-count-props-light">0</span></summary>
      <div class="wm-items" id="wm-items-props-light"></div>
    </details>

    <details class="wm-acc" data-cat="effect-manga">
      <summary>漫画エフェクト <span class="wm-count" id="wm-count-effect-manga">0</span></summary>
      <div class="wm-items" id="wm-items-effect-manga"></div>
    </details>

    <details class="wm-acc" data-cat="movement-action">
      <summary>動作アクション <span class="wm-count" id="wm-count-movement-action">0</span></summary>
      <div class="wm-items" id="wm-items-movement-action"></div>
    </details>

  </section>


  <section class="wm-accordion" id="wm-accordion-nsfw">
  <h3 class="wm-acc-title">NSFW</h3>
  <!-- 先頭に：露出／下着／衣装 -->
  <details class="wm-acc" data-cat="exposure">
    <summary>露出 <span class="wm-count" id="wm-count-exposure">0</span></summary>
    <div class="wm-items" id="wm-items-exposure"></div>
    <p class="wm-tip">※ 露出系（bikini/lingerie/nude）は色込みタグの登録・コピーを推奨</p>
  </details>

  <details class="wm-acc" data-cat="underwear-nsfw">
    <summary>下着（NSFW） <span class="wm-count" id="wm-count-underwear-nsfw">0</span></summary>
    <div class="wm-items" id="wm-items-underwear-nsfw"></div>
  </details>

  <details class="wm-acc" data-cat="outfit-nsfw">
    <summary>衣装（NSFW） <span class="wm-count" id="wm-count-outfit-nsfw">0</span></summary>
    <div class="wm-items" id="wm-items-outfit-nsfw"></div>
  </details>

  <!-- 以降そのまま -->
  <details class="wm-acc" data-cat="expression-nsfw">
    <summary>表情（NSFW） <span class="wm-count" id="wm-count-expression-nsfw">0</span></summary>
    <div class="wm-items" id="wm-items-expression-nsfw"></div>
  </details>

  <details class="wm-acc" data-cat="situation">
    <summary>シチュエーション（NSFW） <span class="wm-count" id="wm-count-situation">0</span></summary>
    <div class="wm-items" id="wm-items-situation"></div>
  </details>

        <details class="wm-acc" data-cat="action-nsfw">
      <summary>NSFWアクション <span class="wm-count" id="wm-count-action-nsfw">0</span></summary>
      <div class="wm-items" id="wm-items-action-nsfw"></div>
    </details>

    <details class="wm-acc" data-cat="action2-nsfw">
      <summary>射精・体液系 <span class="wm-count" id="wm-count-action2-nsfw">0</span></summary>
      <div class="wm-items" id="wm-items-action2-nsfw"></div>
    </details>

    <details class="wm-acc" data-cat="participants">
      <summary>人数・構成 <span class="wm-count" id="wm-count-participants">0</span></summary>
      <div class="wm-items" id="wm-items-participants"></div>
    </details>

  <details class="wm-acc" data-cat="lighting-nsfw">
    <summary>ライティング（NSFW） <span class="wm-count" id="wm-count-lighting-nsfw">0</span></summary>
    <div class="wm-items" id="wm-items-lighting-nsfw"></div>
  </details>

  <details class="wm-acc" data-cat="pose-nsfw">
    <summary>ポーズ（NSFW） <span class="wm-count" id="wm-count-pose-nsfw">0</span></summary>
    <div class="wm-items" id="wm-items-pose-nsfw"></div>
  </details>

  <details class="wm-acc" data-cat="accessory-nsfw">
    <summary>アクセサリー（NSFW） <span class="wm-count" id="wm-count-accessory-nsfw">0</span></summary>
    <div class="wm-items" id="wm-items-accessory-nsfw"></div>
  </details>

  <details class="wm-acc" data-cat="body-nsfw">
    <summary>身体特徴（NSFW） <span class="wm-count" id="wm-count-body-nsfw">0</span></summary>
    <div class="wm-items" id="wm-items-body-nsfw"></div>
  </details>

  <details class="wm-acc" data-cat="nipple-nsfw">
    <summary>乳首（NSFW） <span class="wm-count" id="wm-count-nipple-nsfw">0</span></summary>
    <div class="wm-items" id="wm-items-nipple-nsfw"></div>
  </details>
</section>

  <!-- ========== アコーディオン（Color） ========== -->
  <section class="wm-accordion" id="wm-accordion-color">
    <h3 class="wm-acc-title">Color</h3>
    <details class="wm-acc" data-cat="color">
      <summary>
        色 <span class="wm-count" id="wm-count-color">0</span>
      </summary>
      <div class="wm-items" id="wm-items-color"><!-- 動的挿入 --></div>
      <p class="wm-tip">※ 露出系と併用時は色込みタグ（例：white bikini）を使い、ここはコピーしない</p>
    </details>
  </section>

  <!-- ========== 出力テーブル ========== -->
  <section class="wm-table-wrap">
    <div class="wm-table-head">
      <h3>出力（最大20件）</h3>
      <div class="wm-table-actions">
        <button id="wm-copy-en-all" type="button">Copy EN (All)</button>
        <button id="wm-copy-both-all" type="button">Copy BOTH (All)</button>
        <button id="wm-table-clear" type="button">Clear</button>
      </div>
    </div>

    <table id="wm-table" class="wm-table">
      <thead>
        <tr>
          <th style="width:40%;">日本語</th>
          <th style="width:40%;">English</th>
          <th style="width:20%;">コピー</th>
        </tr>
      </thead>
      <tbody id="wm-table-body"><!-- 動的行 --></tbody>
    </table>
  </section>

  <!-- ========== テンプレート（JSからcloneして使う） ========== -->
  <template id="wm-item-tpl">
    <!-- 単語カード：日本語大／英語小、右にコピー -->
    <button class="wm-item" type="button" data-en="" data-jp="" data-cat="">
      <span class="wm-jp">日本語</span>
      <small class="wm-en">english-tag</small>
      <span class="wm-actions">
        <button class="wm-copy-en" type="button" title="英語のみコピー">EN</button>
        <button class="wm-copy-both" type="button" title="日本語(英語)コピー">BOTH</button>
      </span>
    </button>
  </template>

  <template id="wm-item-tpl-color">
    <!-- Colorは EN のみコピー（BOTHボタンなし） -->
    <button class="wm-item wm-item-color" type="button" data-en="" data-jp="" data-cat="color" data-color-only="1">
      <span class="wm-jp">色名</span>
      <small class="wm-en">color-tag</small>
      <span class="wm-actions">
        <button class="wm-copy-en" type="button" title="英語のみコピー">EN</button>
      </span>
    </button>
  </template>

  <template id="wm-row-tpl">
    <tr data-en="">
      <td class="wm-row-jp">日本語</td>
      <td class="wm-row-en">english-tag</td>
      <td class="wm-row-actions">
        <button class="wm-row-copy-en" type="button">EN</button>
        <button class="wm-row-copy-both" type="button">BOTH</button>
        <button class="wm-row-remove" type="button" title="削除">×</button>
      </td>
    </tr>
  </template>
</section>



      

   <!-- ==== 撮影モード ==== -->
<section id="panelPlanner" class="card" hidden>
  <h2>撮影モード</h2>
  <p class="note">1枚だけ確定出力。学習・量産のホワイトリストなし。</p>

  <div class="row mini"><b>背景</b></div>
  <div id="pl_bg" class="scroller"></div>

  <div class="row mini" style="margin-top:10px"><b>ポーズ</b></div>
  <div id="pl_pose" class="scroller"></div>

  <div class="row mini" style="margin-top:10px"><b>構図</b></div>
  <div id="pl_comp" class="scroller"></div>

  <div class="row mini" style="margin-top:10px"><b>視点</b></div>
  <div id="pl_view" class="scroller"></div>

  <div class="row mini" style="margin-top:10px"><b>表情</b></div>
  <div id="pl_expr" class="scroller"></div>

  <div class="row mini" style="margin-top:10px"><b>ライティング</b></div>
  <div id="pl_light" class="scroller"></div>

  <!-- 18禁 -->
  <div class="panel" style="margin-top:10px">
    <h3>18禁</h3>
    <div class="row" style="margin-top:6px">
      <label class="inline"><input type="checkbox" id="pl_nsfw"> 18禁ON</label>
      <span class="mini">（手動選択のみ）</span>
    </div>
    <div id="pl_nsfwPanel" class="panel" style="margin-top:8px; display:none">
      <div class="row mini">
        <b>レベル上限</b>
        <label class="inline"><input type="radio" name="pl_nsfwLevel" value="L1" checked>R-15</label>
        <label class="inline"><input type="radio" name="pl_nsfwLevel" value="L2">R-18</label>
        <label class="inline"><input type="radio" name="pl_nsfwLevel" value="L3">R-18G</label>
      </div>
      <div class="grid g3" style="margin-top:6px">
        <div class="note mini" style="margin:6px 0">
          ※表情や衣装が被った場合NSFWで選んだものが優先されます。
          追加で色を指定したい場合は単語モードを参照して追加してください。
        </div>
        <div class="mini" style="margin-top:6px">
          ※ 露出・下着・衣装は競合しやすいため、同時に複数を選ぶと出力が崩れる可能性があります。
          なるべく1カテゴリのみを使用してください。
        </div>
        <!-- 先頭に：露出／下着／衣装 -->
        <div><b class="mini">露出</b><div id="pl_nsfw_expo" class="scroller"></div></div>
        <div><b class="mini">下着</b><div id="pl_nsfw_underwear" class="scroller"></div></div>
        <div><b class="mini">衣装</b><div id="pl_nsfw_outfit" class="scroller"></div></div>
      
        <!-- 以降そのまま -->
        <div><b class="mini">表情</b><div id="pl_nsfw_expr" class="scroller"></div></div>
        <div><b class="mini">シチュ</b><div id="pl_nsfw_situ" class="scroller"></div></div>
        <div><b class="mini">ライティング</b><div id="pl_nsfw_light" class="scroller"></div></div>
        <div><b class="mini">ポーズ</b><div id="pl_nsfw_pose" class="scroller"></div></div>
        <div><b class="mini">アクセ</b><div id="pl_nsfw_acc" class="scroller"></div></div>
        <div><b class="mini">身体</b><div id="pl_nsfw_body" class="scroller"></div></div>
        <div><b class="mini">乳首</b><div id="pl_nsfw_nipple" class="scroller"></div></div>
      </div>
      <div class="mini" style="margin-top:6px">※ リストはレベル上限の範囲で表示されます</div>
    </div>
  </div>
    <!-- アクセ（1種＋色） -->
  <div class="row mini" style="margin-top:10px"><b>アクセ（任意）</b></div>
  <div class="panel">
    <div class="mini"><b>固定アクセ（常時1種のみ）</b></div>
    <select id="pl_accSel"></select>
    <div class="wheel-box" style="margin-top:6px">
      <div id="wheel_plAcc" class="wheel"></div><div id="thumb_plAcc" class="thumb"></div>
    </div>
    <div class="row mini">
      S:<input id="sat_plAcc" type="range" min="0" max="100" value="75">
      L:<input id="lit_plAcc" type="range" min="0" max="100" value="50">
    </div>
    <div class="row mini">
      <div id="sw_plAcc" class="swatch"></div>
      <span>色タグ: <code class="tag" id="tag_plAcc">black</code></span>
    </div>
    <div class="mini">※ 未選択なら挿入しません</div>
  </div>

  <hr class="sep">

  <div class="panel">
    <h3>固定タグ / ネガティブ</h3>
    <label>固定タグ（先頭に付与）</label>
    <textarea id="fixedPlanner" rows="3" placeholder="※タグを追加したい場合はここに入力"></textarea>
    <label style="margin-top:10px">ネガティブ（全行）</label>
    <textarea id="negPlanner" rows="3" placeholder="※ 指崩れ・画質劣化などを防ぐプロンプトがデフォルトで入っています。追加したい場合は入力"></textarea>
    <div class="row mini">
      <label class="inline"><input type="checkbox" id="pl_useDefaultNeg" checked> デフォルトのネガティブを使う</label>
    </div>
  </div>
        <!-- 出力フォーマット（学習/量産と同仕様） -->
    <!-- 出力フォーマット（学習/量産と同仕様） -->
    <div class="row" style="gap:8px;margin-top:10px">
      <button id="btnPlanOne" class="btn ok">1件出力</button>
      <label class="inline mini">出力フォーマット
        <select id="fmtPlanner">
          <option value="a1111" selected>Web UI（汎用）</option>
          <option value="invoke">InvokeAI（CLI）</option>
          <option value="comfy">ComfyUI（テキスト）</option>
          <option value="sdnext">SD.Next（dream.py）</option>
          <option value="nai">NovelAI</option>
        </select>
      </label>
      <span style="flex:1"></span>
    </div>
    
      <div class="grid g3" style="margin-top:10px">
    <div>
      <div class="mini" style="margin:0 0 .35rem">全部</div>
      <div class="out" id="outPlannerAll"></div>
      <button id="btnCopyPlannerAll" class="btn ghost small" style="margin-top:6px">全部をコピー</button>
    </div>
    <div>
      <div class="mini" style="margin:0 0 .35rem">Promptのみ</div>
      <div class="out" id="outPlannerPrompt"></div>
      <button id="btnCopyPlannerPrompt" class="btn ghost small" style="margin-top:6px">Promptだけコピー</button>
    </div>
    <div>
      <div class="mini" style="margin:0 0 .35rem">Negativeのみ</div>
      <div class="out" id="outPlannerNeg"></div>
      <button id="btnCopyPlannerNeg" class="btn ghost small" style="margin-top:6px">Negativeだけコピー</button>
    </div>
  </div>
</section>

<!-- 学習モード（バリエーション） -->
<section id="panelLearning" class="card" hidden>
  <div class="row" style="align-items:center">
    <h2 style="margin:0;flex:1">LoRA学習用セット（軽いバリエーション）</h2>
    <span class="badge warn">露出控えめ推奨</span>
    <span class="badge">18禁は手動選択のみ</span>
  </div>

  <div class="note mini">
    基本情報（年齢/性別/髪型/髪色/目/肌色…）は固定。ここで設定する内容がPrompt全行に展開されます。  
    ※出力される形式は <code>solo, 1girl/1boy, 基本情報 + 以下の選択要素</code> です。
  </div>

  <!-- 服の扱い：基本服 or なし -->
  <div class="panel" style="margin-top:8px">
    <div class="row mini">
      <b>服の扱い</b>
      <span class="mini" style="margin-left:.5rem">（学習の汎用性を上げたい場合は「服を入れない」推奨）</span>
    </div>
    <div class="row" style="gap:12px;margin-top:6px">
      <label class="inline">
        <input type="radio" name="learnWearMode" id="rbWearBasic" value="basic" checked>
        基本情報の服を使う
      </label>
      <label class="inline">
        <input type="radio" name="learnWearMode" id="rbWearGeneric" value="generic">
        服は入れない（タグを追加しない）
      </label>
    </div>
    <div class="note mini" style="margin-top:6px">
      出力例（基本服 ON）: <code>..., white t-shirt, sky blue shorts, ...</code><br>
      出力例（服を入れない）: <code>...（服タグなし）...</code>
    </div>
    <!-- 学習モードでは参照表示に変更 -->
    <div class="panel" style="margin-top:12px">
      <div class="mini"><b>固定アクセ（基本情報から継承）</b></div>
      <div class="note mini">
        設定は「基本情報」タブで行ってください。ここでは現在の設定を表示します。
      </div>
      <div id="learnAccDisplay" class="mini">
        現在の設定: <span id="currentAccDisplay">未設定</span>
      </div>
    </div>

  <!-- NSFW -->
  <div class="panel" style="margin-top:12px">
    <h3>18禁</h3>
    <div class="row" style="margin-top:8px">
      <label class="inline"><input type="checkbox" id="nsfwLearn"> 18禁ON</label>
      <span class="mini">（衣装と体型のみ反映。服トグルより優先）</span>
    </div>

    <div id="nsfwLearnPanel" class="panel" style="margin-top:8px; display:none">
      <div class="row mini">
        <b>レベル上限</b>
        <label class="inline"><input type="radio" name="nsfwLevelLearn" value="L1" checked>R-15</label>
        <label class="inline"><input type="radio" name="nsfwLevelLearn" value="L2">R-18</label>
        <label class="inline"><input type="radio" name="nsfwLevelLearn" value="L3">R-18G</label>
      </div>

      <div class="grid g2" style="margin-top:10px">
        <div>
          <b class="mini">NSFW衣装</b>
          <div id="nsfwL_outfit" class="scroller"></div>
        </div>
        <div>
          <b class="mini">NSFW体型</b>
          <div id="nsfwL_body" class="scroller"></div>
        </div>
      </div>

      <div class="note mini" style="margin:8px 0">
        出力例: <code>... , bunny suit, voluptuous ...</code>  
        ※ONにすると選んだNSFW衣装/体型が必ず含まれます。
      </div>
    </div>
  </div>

  <!-- 固定タグ / ネガティブ -->
  <div class="grid g2" style="margin-top:12px">
    <div class="panel">
      <h3>固定タグ / ネガティブ</h3>
      <label>固定タグ（全行に付与）</label>
      <textarea id="fixedLearn" rows="3"
        placeholder="※タグを追加したい場合はここに入力"></textarea>

      <label style="margin-top:10px">ネガティブ（全行）</label>
      <textarea id="negLearn" rows="3"
        placeholder="※ 指崩れ・画質劣化などを防ぐプロンプトがデフォルトで入っています。追加したい場合は入力"></textarea>

      <div class="row mini">
        <label>
          <input type="checkbox" id="useDefaultNeg" checked>
          デフォルトのネガティブプロンプトを使う
        </label>
      </div>
      <div class="note mini" style="margin-top:6px">
        出力例: <code>--neg bad hands, blurry, lowres</code>
      </div>
    </div>

    <!-- 学習セット生成 -->
    <div class="card" id="learnBatchCard">
      <div class="row">
        <h3 style="margin:0">学習セット生成</h3>
        <select id="countLearn" class="btn small" style="background:#1d2432;color:#e6eeff">
          <option>20</option><option selected>24</option><option>30</option>
        </select>
        <label class="inline mini">出力フォーマット
          <select id="fmtLearnBatch">
            <option value="a1111" selected>Web UI（汎用）</option>
            <option value="invoke">InvokeAI（CLI）</option>
            <option value="comfy">ComfyUI（テキスト）</option>
            <option value="sdnext">SD.Next（dream.py）</option>
            <option value="nai">NovelAI</option>
          </select>
        </label>
        <button id="btnBatchLearn" class="btn ok">セット生成</button>
        <span style="flex:1"></span>
        <button id="btnCsvLearn" class="btn ghost">ローカル保存（CSV）</button>
        <button id="btnCloudLearn" class="btn ghost">クラウド保存（CSV）</button>
        <span id="toast" class="toast mini" hidden></span>
      </div>
      <div class="note mini" style="margin-top:6px">
        ※生成結果はテキスト/CSV/テーブルに出力されます
      </div>
    </div>
  </div>

  <!-- 出力欄 -->
  <div class="grid g1" style="margin-top:10px">
    <div>
      <h4 style="margin:0 0 6px">テキスト</h4>
      <div class="mini">全部（Prompt＋Negative）</div>
      <div class="out" id="outLearnAll"></div>
      <button id="btnCopyLearnAll" class="btn ghost small">全部をコピー</button>

      <div class="mini" style="margin-top:.75rem">Promptのみ</div>
      <div class="out" id="outLearnPrompt"></div>
      <button id="btnCopyLearnPrompt" class="btn ghost small">Promptだけコピー</button>

      <div class="mini" style="margin-top:.75rem">Negativeのみ</div>
      <div class="out" id="outLearnNeg"></div>
      <button id="btnCopyLearnNeg" class="btn ghost small">Negativeだけコピー</button>
    </div>

    <div style="margin-top:12px">
      <h4 style="margin:0 0 6px">テーブル</h4>
      <table class="table" id="tblLearn">
        <thead><tr><th>#</th><th>seed</th><th>prompt</th><th>negative</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</section>

    <!-- 量産モード（従来どおり） -->
    <section id="panelProduction" class="card" hidden>
      <h2>量産モード（LoRA完成後）
        <span class="badge ok">多様性重視</span><span class="badge">アクセ3枠</span><span class="badge">18禁は手動選択のみ</span>
      </h2>
        <div class="note mini" style="margin:6px 0">
          量産では服の色は基本色1色をベースにし、バリエーションを持たせたい項目だけチェックを増やすのがおすすめです。<br>
          すべての要素を一度に揺らすと組み合わせがバラけすぎて安定しないため、他の部分は固定にしておくと安定した量産ができます。<br>
        </div>

<!-- 服 / 背景 / 表情：3カラムだけでまず閉じる -->
<div class="grid g3">
  <div class="panel">
    <h3>服（カテゴリ別 / 複数可）</h3>

    <div class="row mini" style="gap:10px;margin:0 0 8px">
      <label class="inline"><input type="checkbox" id="allowBottomSwap"> 「ボトムス ↔ スカート」置換を許可</label>
      <span class="mini">※ どちらか未選択時にもう一方から補完する想定</span>
    </div>

    <div class="grid g2">
      <div class="panel">
        <h4 style="margin:0 0 6px">トップス（複数可）</h4>
        <div id="p_outfit_top" class="scroller"></div>
      </div>
      <div class="panel">
        <h4 style="margin:0 0 6px">ボトムス（ズボン・複数可）</h4>
        <div id="p_outfit_pants" class="scroller"></div>
      </div>
      <div class="panel">
        <h4 style="margin:0 0 6px">スカート（複数可）</h4>
        <div id="p_outfit_skirt" class="scroller"></div>
      </div>
      <div class="panel">
        <h4 style="margin:0 0 6px">ワンピース（複数可）</h4>
        <div id="p_outfit_dress" class="scroller"></div>
        <div class="mini">※ ワンピース採用行は下カラー無効</div>
      </div>
      <div class="panel">
        <h4 style="margin:0 0 6px">靴（複数可）</h4>
        <div id="p_outfit_shoes" class="scroller"></div>
      </div>
    </div>
  </div>
</div> <!-- ←ここで .grid g3 を閉じる -->
      
<!-- === 服カラー（量産の基本色）: 置き換え開始 === -->
<div class="card" id="prodColorCard" style="margin-top:10px">
  <h4 style="margin:0 0 6px">服カラー（量産の基本色）</h4>
  <div class="mini">指定した色タグを各行に付与します。ワンピース採用行では下カラーは自動で無効。</div>
  <!-- 量産の使い方ノート -->
  <div class="note mini" style="margin-top:6px">
    量産では服の色は基本色1色をベースにし、バリエーションを持たせたい項目だけチェックを増やすのがおすすめです。
    すべてを同時に揺らすと組み合わせがバラけて不安定になるため、他の要素は固定>にしてください。
  </div>

  <div class="grid g3" style="margin-top:8px">
    <!-- トップス -->
    <div class="panel" id="panel_p_top">
      <div class="row mini">
        <label class="inline"><input type="checkbox" id="p_use_top"> トップス色を使う</label>
      </div>
      <div class="wheel-box">
        <div id="wheel_p_top" class="wheel"></div><div id="thumb_p_top" class="thumb"></div>
      </div>
      <div class="row mini">
        S:<input id="sat_p_top" type="range" min="0" max="100" value="80">
        L:<input id="lit_p_top" type="range" min="0" max="100" value="55">
      </div>
      <!-- 色タグ行（重なり防止のためflex＋wrap） -->
      <div class="row mini" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-top:6px">
        <div id="sw_p_top" class="swatch"></div>
        <span>色タグ: <code class="tag" id="tag_p_top">—</code></span>
      </div>
    </div>

    <!-- ボトムス（順序と重なりを修正：SL → 色タグ → 注意書き） -->
    <div class="panel" id="panel_p_bottom">
      <div class="row mini">
        <label class="inline"><input type="checkbox" id="p_use_bottom"> 下カラーを使う</label>
      </div>
      <div class="wheel-box">
        <div id="wheel_p_bottom" class="wheel"></div><div id="thumb_p_bottom" class="thumb"></div>
      </div>
      <div class="row mini">
        S:<input id="sat_p_bottom" type="range" min="0" max="100" value="70">
        L:<input id="lit_p_bottom" type="range" min="0" max="100" value="50">
      </div>
      <!-- 色タグ行（flex-wrapで折り返し、被りを防止） -->
      <div class="row mini" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-top:6px">
        <div id="sw_p_bottom" class="swatch"></div>
        <span>色タグ: <code class="tag" id="tag_p_bottom">—</code></span>
      </div>
      <!-- 注意書きは右寄せ＆独立行に -->
      <div class="mini" style="text-align:right;margin-top:4px;display:block;clear:both">
        ※ ワンピース選択時は自動で無効化されます
      </div>
    </div>

    <!-- 靴 -->
    <div class="panel" id="panel_p_shoes">
      <div class="row mini">
        <label class="inline"><input type="checkbox" id="p_use_shoes"> 靴色を使う</label>
      </div>
      <div class="wheel-box">
        <div id="wheel_p_shoes" class="wheel"></div><div id="thumb_p_shoes" class="thumb"></div>
      </div>
      <div class="row mini">
        S:<input id="sat_p_shoes" type="range" min="0" max="100" value="0">
        L:<input id="lit_p_shoes" type="range" min="0" max="100" value="30">
      </div>
      <div class="row mini" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-top:6px">
        <div id="sw_p_shoes" class="swatch"></div>
        <span>色タグ: <code class="tag" id="tag_p_shoes">—</code></span>
      </div>
    </div>
  </div>
</div>
<!-- === 服カラー（量産の基本色）: 置き換え終了 === -->

<!-- === アクセ（3スロット・色指定）: 置き換え開始 === -->
<div class="card" id="accCard" style="margin-top:10px">
  <h3 style="margin:0 0 6px">アクセ（3スロット・色指定）</h3>
  <div class="grid g3">
    <div class="panel">
      <div class="mini">アクセ A</div>
      <select id="p_accA"></select>
      <div class="wheel-box" style="margin-top:6px">
        <div id="wheel_accA" class="wheel"></div><div id="thumb_accA" class="thumb"></div>
      </div>
      <div class="row mini">S:<input id="sat_accA" type="range" min="0" max="100" value="80">
        L:<input id="lit_accA" type="range" min="0" max="100" value="50"></div>
      <div class="row mini" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
        <div id="sw_accA" class="swatch"></div>
        <span>色タグ: <code class="tag" id="tag_accA">red</code></span>
      </div>
    </div>

    <details>
      <summary class="mini"><span class="caret">▶</span> アクセ B</summary>
      <div class="panel" style="margin-top:6px">
        <select id="p_accB"></select>
        <div class="wheel-box" style="margin-top:6px">
          <div id="wheel_accB" class="wheel"></div><div id="thumb_accB" class="thumb"></div>
        </div>
        <div class="row mini">S:<input id="sat_accB" type="range" min="0" max="100" value="80">
          L:<input id="lit_accB" type="range" min="0" max="100" value="50"></div>
        <div class="row mini" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
          <div id="sw_accB" class="swatch"></div>
          <span>色タグ: <code class="tag" id="tag_accB">blue</code></span>
        </div>
      </div>
    </details>

    <details>
      <summary class="mini"><span class="caret">▶</span> アクセ C</summary>
      <div class="panel" style="margin-top:6px">
        <select id="p_accC"></select>
        <div class="wheel-box" style="margin-top:6px">
          <div id="wheel_accC" class="wheel"></div><div id="thumb_accC" class="thumb"></div>
        </div>
        <div class="row mini">S:<input id="sat_accC" type="range" min="0" max="100" value="80">
          L:<input id="lit_accC" type="range" min="0" max="100" value="50"></div>
        <div class="row mini" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
          <div id="sw_accC" class="swatch"></div>
          <span>色タグ: <code class="tag" id="tag_accC">green</code></span>
        </div>
      </div>
    </details>
  </div>
</div>
<!-- === アクセ: 置き換え終了 === -->
  <div class="mini" style="margin-top:6px">※ 未選択スロットは無視</div>
<div class="panel">
  <h3>背景（複数可）</h3>
  <div id="p_bg" class="scroller"></div>

  <h3 style="margin-top:10px">ポーズ（複数可）</h3>
  <div id="p_pose" class="scroller"></div>

  <!-- 追加：構図（複数可） -->
  <h3 style="margin-top:10px">構図（複数可）</h3>
  <div id="p_comp" class="scroller"></div>

  <!-- 追加：表情（複数可） -->
  <h3 style="margin-top:10px">表情（複数可）</h3>
  <div id="p_expr" class="scroller"></div>
</div>

<div class="panel">
  <h3>18禁</h3>
  <div class="row">
    <label class="inline"><input id="nsfwProd" type="checkbox"> 18禁ON</label>
    <span class="mini">（選んだもののみ使用）</span>
  </div>
  <div id="nsfwProdPanel" style="display:none">
    <div class="row mini" style="margin-top:6px">
      <b>レベル上限</b>
      <label class="inline"><input type="radio" name="nsfwLevelProd" value="L1" checked>R-15</label>
      <label class="inline"><input type="radio" name="nsfwLevelProd" value="L2">R-18</label>
      <label class="inline"><input type="radio" name="nsfwLevelProd" value="L3">R-18G</label>
    </div>
    <div class="grid g3" style="margin-top:6px">
      <div class="note mini" style="margin:6px 0">
        ※表情や衣装が被った場合NSFWで選んだものが優先されます。<br>
        追加で色を指定したい場合は単語モードを参照して追加してください。<br>
      </div>
      <div class="mini" style="margin-top:6px">
        ※ 露出・下着・衣装は競合しやすいため、同時に複数を選ぶと出力が崩れる可能性があります。<br>
        なるべく1カテゴリのみを使用してください。<br>
      </div>
      <!-- 先頭に：露出／下着／衣装 -->
      <div><b class="mini">露出</b><div id="nsfwP_expo" class="scroller"></div></div>
      <div><b class="mini">下着</b><div id="nsfwP_underwear" class="scroller"></div></div>
      <div><b class="mini">衣装</b><div id="nsfwP_outfit" class="scroller"></div></div>

      <!-- 以降そのまま -->
      <div><b class="mini">表情</b><div id="nsfwP_expr" class="scroller"></div></div>
      <div><b class="mini">シチュ</b><div id="nsfwP_situ" class="scroller"></div></div>
      <div><b class="mini">ライティング</b><div id="nsfwP_light" class="scroller"></div></div>
      <div><b class="mini">ポーズ</b><div id="nsfwP_pose" class="scroller"></div></div>
      <div><b class="mini">アクセ</b><div id="nsfwP_acc" class="scroller"></div></div>
      <div><b class="mini">身体</b><div id="nsfwP_body" class="scroller"></div></div>
      <div><b class="mini">乳首</b><div id="nsfwP_nipple" class="scroller"></div></div>
    </div>
  </div>
</div>

<div class="grid g2">
  <div class="panel">
    <h3>固定タグ / ネガティブ</h3>
    <label>固定タグ（先頭に付与）</label>
    <textarea id="fixedProd" rows="3" placeholder="※タグを追加したい場合はここに入力"></textarea>
    <label style="margin-top:10px">ネガティブ（量産用）</label>
    <textarea id="p_neg" rows="3" placeholder="※ 共通ネガに加えて、量産時のみ追加したい内容があれば入力"></textarea>
  </div>

  <div class="panel">
    <h3>出力設定</h3>
    <div class="row">
      <label class="inline"><input type="radio" name="seedMode" value="fixed" checked> seed固定</label>
      <label class="inline"><input type="radio" name="seedMode" value="vary"> 行ごとに微差seed</label>
    </div>
    <div class="row mini"><div><b>Seedの説明</b></div>
      <div>固定＝全行同じ / 微差＝行ごとに少し揺らぎ</div>
    </div>
    <div class="row" style="margin-top:6px">
      <label>件数</label>
      <select id="countProd" class="btn small" style="background:#1d2432;color:#e6eeff">
        <option>20</option><option>30</option><option selected>50</option>
      </select>
      <label class="inline mini">出力フォーマット
        <select id="fmtProd">
          <option value="a1111" selected>Web UI（汎用）</option>
          <option value="invoke">InvokeAI（CLI）</option>
          <option value="comfy">ComfyUI（テキスト）</option>
          <option value="sdnext">SD.Next（dream.py）</option>
          <option value="nai">NovelAI</option>
        </select>
      </label>
    </div>
  </div>
</div>
      <div class="card">
        <div class="row">
          <button id="btnGenProd" class="btn ok">量産セット生成</button>
          <span style="flex:1"></span>
          <button id="btnCsvProd" class="btn ghost" title="量産セットをCSVでローカル保存">ローカル保存（CSV）</button>
          <button id="btnCloudProd" class="btn ghost" title="量産セットをクラウドへ保存">クラウド保存（CSV）</button>
        </div>
        <div class="grid g1" style="margin-top:10px">
        <!-- テキスト（上） -->
        <div>
          <h3>コピー用（テキスト）</h3>
          <div class="mini" style="margin:.25rem 0 .35rem">全部</div>
          <div class="out" id="outProdAll"></div>
          <button id="btnCopyProdAll" class="btn ghost small" style="margin-top:6px">全部をコピー</button>
      
          <div class="mini" style="margin:.75rem 0 .35rem">Promptのみ</div>
          <div class="out" id="outProdPrompt"></div>
          <button id="btnCopyProdPrompt" class="btn ghost small" style="margin-top:6px">Promptだけコピー</button>
      
          <div class="mini" style="margin:.75rem 0 .35rem">Negativeのみ</div>
          <div class="out" id="outProdNeg"></div>
          <button id="btnCopyProdNeg" class="btn ghost small" style="margin-top:6px">Negativeだけコピー</button>
        </div>
      
        <!-- テーブル（下） -->
        <div style="margin-top:12px">
          <h3>テーブル表示</h3>
          <table class="table" id="tblProd">
            <thead><tr><th>#</th><th>seed</th><th>prompt</th><th>negative</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- 設定タブ（そのまま） -->
    <section id="panelSettings" class="card" hidden>
      <h2>⚙️ 設定</h2>
      <div class="grid g3">
        <div class="panel">
          <h3>クラウド保存（GAS）</h3>
          <label>クラウド保存URL（GAS）</label>
          <input id="set_gasUrl" type="text" placeholder="https://script.google.com/macros/s/XXXX/exec">
          <label style="margin-top:8px">GAS トークン（任意 / Bearer）</label>
          <input id="set_gasToken" type="password" placeholder="****">
          <div class="row" style="margin-top:8px">
            <button id="btnTestGAS" class="btn ghost small">接続テスト</button>
            <span id="gasTestResult" class="mini"></span>
          </div>
        </div>

        <div class="panel">
          <h3>辞書 I/O（SFW / NSFW）</h3>
          <input type="file" id="importDict" accept="application/json" hidden>
          <label for="importDict" class="btn small">辞書インポート</label>
          <button id="btnExport" class="btn ghost small" title="辞書をJSONで保存">辞書エクスポート</button>
        </div>

        <div class="panel">
          <h3>アプリ管理</h3>
          <div class="note mini">辞書インポート後に表示が崩れたらキャッシュ初期化でOK。</div>
          <button id="btnSaveSettings" class="btn ok small">設定を保存</button>
          <button id="btnResetSettings" class="btn bad small" style="margin-left:6px">キャッシュ初期化</button>
        </div>
      </div>
    </section>
  </main>

    <!-- app.js より前に置くこと！ -->
  <script src="dict/default_sfw.js" defer></script>
  <script src="dict/default_nsfw.js" defer></script>
      <!-- head内に追加 -->
  <script src="dict/commercial_lora.js" defer></script>
  <script src="js/core/commercial-lora.js" defer></script>
  <script src="js/core/manga-mode.js"></script>
  <script src="js/presets/manga-sfw-presets.js"></script>
  <script src="js/presets/manga-nsfw-presets.js"></script>
  <script src="js/presets/manga-preset-system.js"></script>
  <script src="js/core/app.js" defer></script>
  <script>
(() => {
  // ===== スコープ：基本情報タブ (#panelBasic) 内だけ =====
  const scope = document.getElementById('panelBasic');
  if (!scope) return; // 構成変更時も安全に無視

  // スコープ内セレクタ
  const $  = (sel) => scope.querySelector(sel);
  const $$ = (sel) => scope.querySelectorAll(sel);

  // outfit ラジオの状態
  const getIsOnepiece = () => {
    const r = scope.querySelector('input[name="outfitMode"]:checked');
    return r?.value === 'onepiece';
  };

  // 見た目＋操作の無効化（スコープ内の要素だけ触る）
  const setDisabledDeep = (root, on) => {
    if (!root) return;
    root.classList.toggle('is-disabled', !!on);
    root.querySelectorAll('input, select, textarea, button, fieldset').forEach(el => {
      el.disabled = !!on;
    });
  };

  // 下カテゴリ制御関数を追加
  const updateBottomCategory = () => {
    const selectedCat = scope.querySelector('input[name="bottomCat"]:checked')?.value || 'pants';
    const fsPants = scope.querySelector('#fsBottom_pants');
    const fsSkirt = scope.querySelector('#fsBottom_skirt');
    
    if (fsPants && fsSkirt) {
      if (selectedCat === 'pants') {
        fsPants.style.display = '';
        fsSkirt.style.display = 'none';
        fsSkirt.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
      } else {
        fsPants.style.display = 'none';
        fsSkirt.style.display = '';
        fsPants.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
      }
    }
  };

  // 上下/ワンピースの切替（修正版）
  const applyOutfitMode = () => {
    const isOnepiece = getIsOnepiece();

    const fsDress   = $('#fsDress');
    const dressPanel = $('#fsDress')?.closest('.panel');
    const topPanel  = $('#outfit_top')?.closest('.panel');
    const fsPants   = $('#fsBottom_pants');
    const fsSkirt   = $('#fsBottom_skirt');
    const bottomCat = $('#bottomCategoryRadios')?.closest('.panel');
    const shoesPanel = $('#outfit_shoes')?.closest('.panel');

    if (isOnepiece) {
      // ワンピース側のみ操作可
      setDisabledDeep(fsDress, false);
      if (dressPanel) setDisabledDeep(dressPanel, false);   // 親パネルも復活

      if (shoesPanel) setDisabledDeep(shoesPanel, false); // 靴は有効

      // セパレート側は見た目も操作もオフ
      setDisabledDeep(topPanel,  true);
      setDisabledDeep(fsPants,   true);
      setDisabledDeep(fsSkirt,   true);
      setDisabledDeep(bottomCat, true);
    } else {
      // セパレート側のみ操作可
      setDisabledDeep(topPanel,  false);
      setDisabledDeep(fsPants,   false);
      setDisabledDeep(fsSkirt,   false);
      setDisabledDeep(bottomCat, false);
      if (shoesPanel) setDisabledDeep(shoesPanel, false); // 靴は有効

      // ワンピースは無効化（誤操作防止）
      setDisabledDeep(fsDress, true);
      if (dressPanel) setDisabledDeep(dressPanel, true);
    }
    
    // 下カテゴリの表示更新
    updateBottomCategory();
  };

  // ラジオにバインド（#panelBasic 内のみ）
  $$('#panel_outfitFixed input[name="outfitMode"]').forEach(r => {
    r.addEventListener('change', applyOutfitMode);
    r.addEventListener('input',  applyOutfitMode);
  });

  // 下カテゴリのラジオボタンにイベント追加
  scope.querySelectorAll('input[name="bottomCat"]').forEach(radio => {
    radio.addEventListener('change', updateBottomCategory);
  });

  // 初期適用＋bfcache対策（※他タブには触れない）
  applyOutfitMode();
  window.addEventListener('pageshow', applyOutfitMode);

  // 必要なら外から再適用できるように（任意）
  window.applyOutfitMode = applyOutfitMode;
  window.updateBottomCategory = updateBottomCategory;
})();
</script>
  <!-- タブ切替（planner 初回表示で pmInitPlannerOnce を呼ぶ） -->
  <script>
  // 既存の $ / $$ が無い環境でも動くよう保険
  window.$  = window.$  || (s => document.querySelector(s));
  window.$$ = window.$$ || (s => document.querySelectorAll(s));

  function initTabs(){
  $$(".tab").forEach(tab => {
    tab.addEventListener("click", () => {
      $$(".tab").forEach(x => x.classList.remove("active"));
      tab.classList.add("active");

      const m = tab.dataset.mode;
      $("#panelBasic").hidden      = (m !== "basic");
      $("#panelManga").hidden = (m !== "manga");
      $("#panelWordMode").hidden   = (m !== "word"); 
      $("#panelPlanner").hidden    = (m !== "planner");
      $("#panelLearning").hidden   = (m !== "learning");
      $("#panelProduction").hidden = (m !== "production");
      $("#panelSettings").hidden   = (m !== "settings");

      // ★★★ 各タブの初回表示時に色ピッカーを初期化 ★★★
      if (m === "planner" && typeof pmInitPlannerOnce === "function") {
        pmInitPlannerOnce();
      }
      
      if (m === "learning" && typeof initLearningColorWheels === "function") {
        setTimeout(initLearningColorWheels, 100);
      }
      
      if (m === "production" && typeof initProductionColorWheels === "function") {
        setTimeout(initProductionColorWheels, 100);
      }
    });
  });

  const initial = document.querySelector(".tab.active") || document.querySelector(".tab");
  if (initial) initial.click();
}
  document.addEventListener("DOMContentLoaded", initTabs);
  </script>
  <script>
(() => {
  function getActiveMode(){
    const t = document.querySelector('.tab.active');
    return t ? t.dataset.mode : 'basic';
  }
  const FIXED_IDS = { planner:'fixedPlanner', learning:'fixedLearn', production:'fixedProd' };
  const NEG_IDS   = { planner:'negPlanner',   learning:'negLearn',   production:'p_neg' };

  function defineProxyInput(id, getter){
    let el = document.getElementById(id);
    if (!el) {
      el = document.createElement('textarea');
      el.id = id; el.style.display = 'none';
      document.body.appendChild(el);
    }
    Object.defineProperty(el, 'value', { get: getter, set: () => {} });
  }

  defineProxyInput('fixedManual', () => {
    const id = FIXED_IDS[getActiveMode()];
    return id ? (document.getElementById(id)?.value || '') : '';
  });
  defineProxyInput('negGlobal', () => {
    const id = NEG_IDS[getActiveMode()];
    return id ? (document.getElementById(id)?.value || '') : '';
  });
})();
</script>
<script>
/* ========= 服の完成タグをUIで直接生成 ========= */

/* 例:
   selectedOutfits = ["t-shirt","shorts"]  // UIの選択配列（辞書の tag 文字列）
   colorTags = { top:"orange", bottom:"blue", shoes:"black" } // ピッカーの文字タグ
*/
function makeFinalOutfitTags(selectedOutfits, colorTags) {
  const sel = Array.isArray(selectedOutfits) ? selectedOutfits.filter(Boolean) : [];
  const colors = Object.assign({ top:"", bottom:"", shoes:"" }, (colorTags||{}));

  // 辞書があればカテゴリを引く（なければ推定）
  const catMap = new Map();
  try {
    const dict = (window.SFW && Array.isArray(SFW.outfit)) ? SFW.outfit : [];
    for (const e of dict) if (e && e.tag && e.cat) catMap.set(String(e.tag).toLowerCase(), String(e.cat).toLowerCase());
  } catch {}

  const getCat = (tag) => {
    const k = String(tag||"").toLowerCase();
    if (catMap.has(k)) return catMap.get(k);
    // 簡易推定（辞書が無い/足りない場合の保険）
    if (/(dress|kimono|yukata|cheongsam|hanbok|sari|uniform|gown)$/i.test(k)) return "dress";
    if (/(skirt)$/i.test(k)) return "skirt";
    if (/(jeans|pants|trousers|shorts|overalls|hakama)$/i.test(k)) return "pants";
    if (/(boots|sneakers|loafers|mary janes|socks)$/i.test(k)) return "shoes";
    return "top"; // 迷ったら top とみなす
  };

  const hasDress = sel.some(t => getCat(t) === "dress");

  // すでに色名で始まってたら二重付与しないための軽いチェック
  const colorPool = new Set(
    ((window.SFW && Array.isArray(SFW.colors) ? SFW.colors.map(c=>c.tag) : [])).concat([
      "white","black","red","blue","green","yellow","pink","purple","orange","brown","gray","silver","gold","beige","navy",
      "light blue","sky blue","teal","turquoise","lavender","violet","magenta","crimson","scarlet","emerald","olive",
      "khaki","ivory","peach","mint"
    ]).map(s=>String(s).toLowerCase())
  );
  const startsWithColor = (s)=>{
    const t = String(s||"").toLowerCase();
    return Array.from(colorPool).some(c => t.startsWith(c+" "));
  };

  const out = [];
  if (hasDress) {
    // ワンピは top の色を前置き。下の色は無効（下は出力しない）
    for (const t of sel) {
      const cat = getCat(t);
      if (cat === "dress") {
        const tagged = startsWithColor(t) ? t : (colors.top ? `${colors.top} ${t}` : t);
        out.push(tagged);
      } else if (cat === "shoes") {
        const tagged = startsWithColor(t) ? t : (colors.shoes ? `${colors.shoes} ${t}` : t);
        out.push(tagged);
      }
      // top/pants/skirt は無視
    }
  } else {
    // 通常モード：top / bottom / shoes を色前置
    for (const t of sel) {
      const cat = getCat(t);
      if (cat === "top") {
        out.push(startsWithColor(t) ? t : (colors.top    ? `${colors.top} ${t}`    : t));
      } else if (cat === "pants" || cat === "skirt") {
        out.push(startsWithColor(t) ? t : (colors.bottom ? `${colors.bottom} ${t}` : t));
      } else if (cat === "shoes") {
        out.push(startsWithColor(t) ? t : (colors.shoes  ? `${colors.shoes} ${t}`  : t));
      } else if (cat === "dress") {
        // 念のため（hasDress=falseなので単独ワンピのとき）
        out.push(startsWithColor(t) ? t : (colors.top ? `${colors.top} ${t}` : t));
      } else {
        out.push(t); // 未分類はそのまま
      }
    }
  }
  return out;
}

/* ===== 統合：最終トークンを組み立てる（髪・目は今まで通り） =====
   base = 髪色・目色・体型など（服以外）のトークン配列
   outfits = 服の選択結果（タグ配列）
   colorTags = { top, bottom, shoes } ピッカーの文字タグ
*/
function buildFinalTokens(base, outfits, colorTags) {
  const a = Array.isArray(base) ? base.filter(Boolean) : [];
  const b = makeFinalOutfitTags(outfits, colorTags);
  return a.concat(b);
}
</script>
<script>

  // タブ初期化後に1回（遅延）
window.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => {
    window.refreshOutfitDict?.();
    window.initWearColorEngine?.(); // catalog.size ログが>0になるはず
  }, 0);
});

// さらに保険：#panelBasic 内の 5 つのリストに MutationObserver
['#outfit_top','#outfit_pants','#outfit_skirt','#outfit_dress','#outfit_shoes'].forEach(sel=>{
  const host = document.querySelector(sel);
  if (!host) return;
  const mo = new MutationObserver(()=> {
    window.refreshOutfitDict?.();
    window.initWearColorEngine?.();
  });
  mo.observe(host, { childList:true, subtree:true });
});


</script>
<script>
/* ===== 漫画カテゴリ単語モード統合スクリプト ===== */
/* このスクリプトをindex.htmlの最後、</body>の直前に配置してください */

(function() {
  'use strict';
  
  // 初期化完了フラグ
  let mangaWordModeInitialized = false;
  
  // 漫画カテゴリと辞書プロパティのマッピング
  const MANGA_CATEGORY_MAPPING = {
    // SFW漫画カテゴリ
    'worldview': 'worldview',
    'emotion-primary': 'emotion_primary',
    'emotion-detail': 'emotion_detail',
    'mouth-state': 'mouth_state',
    'eye-state': 'eye_state',
    'gaze': 'gaze',
    'pose-manga': 'pose_manga',
    'hand-gesture': 'hand_gesture',
    'movement-action': 'movement_action',
    'props-light': 'props_light',
    'effect-manga': 'effect_manga',
    'camera-view': 'camera_view',
    'camera-angle': 'camera_angle',
    'interaction-sfw': 'interaction_sfw',
    
    // ネガティブプロンプト系
    'negative-essential': 'negative_essential',
    'negative-quality': 'negative_quality',
    'negative-unwanted': 'negative_unwanted',
    'negative-face': 'negative_face',
    'negative-body': 'negative_body',
    'negative-style': 'negative_style',
    'negative-composition': 'negative_composition',
    'negative-clothing': 'negative_clothing',
    
    // NSFW漫画カテゴリ
    'interaction-nsfw': 'interaction_nsfw',
    'background-nsfw': 'background_nsfw'
  };
  
  // 辞書データの完全性チェック
  function checkDictionaryCompleteness() {
    console.log('=== 辞書完全性チェック ===');
    
    const missingCategories = [];
    const availableCategories = [];
    
    // SFWカテゴリをチェック
    Object.entries(MANGA_CATEGORY_MAPPING).forEach(([displayName, dictKey]) => {
      let found = false;
      let count = 0;
      
      // SFWから検索
      if (window.SFW && window.SFW[dictKey] && Array.isArray(window.SFW[dictKey])) {
        count = window.SFW[dictKey].length;
        if (count > 0) {
          found = true;
          availableCategories.push({ name: displayName, dict: 'SFW', key: dictKey, count });
        }
      }
      
      // NSFWから検索
      if (!found && window.NSFW && window.NSFW[dictKey] && Array.isArray(window.NSFW[dictKey])) {
        count = window.NSFW[dictKey].length;
        if (count > 0) {
          found = true;
          availableCategories.push({ name: displayName, dict: 'NSFW', key: dictKey, count });
        }
      }
      
      if (!found) {
        missingCategories.push({ name: displayName, key: dictKey });
      }
    });
    
 //   console.log(`利用可能カテゴリ: ${availableCategories.length}`);
 //   availableCategories.forEach(cat => {
 //     console.log(`  ✓ ${cat.name} (${cat.dict}.${cat.key}): ${cat.count}件`);
 //   });
    
 //   if (missingCategories.length > 0) {
 //     console.log(`不足カテゴリ: ${missingCategories.length}`);
 //     missingCategories.forEach(cat => {
 //       console.log(`  ✗ ${cat.name} (${cat.key}): 辞書に存在しない`);
 //     });
    }
    
    return { available: availableCategories, missing: missingCategories };
  }
  
  // HTMLコンテナの存在チェック
  function checkHTMLContainers() {
    console.log('=== HTMLコンテナチェック ===');
    
    const missingContainers = [];
    const availableContainers = [];
    
    Object.keys(MANGA_CATEGORY_MAPPING).forEach(displayName => {
      const containerId = `wm-items-${displayName}`;
      const countId = `wm-count-${displayName}`;
      
      const container = document.getElementById(containerId);
      const counter = document.getElementById(countId);
      
      if (container && counter) {
        availableContainers.push(displayName);
      } else {
        missingContainers.push({
          name: displayName,
          hasContainer: !!container,
          hasCounter: !!counter
        });
      }
    });
    
  //  console.log(`利用可能コンテナ: ${availableContainers.length}`);
  //  availableContainers.forEach(name => {
  //    console.log(`  ✓ ${name}`);
  //  });
    
  //  if (missingContainers.length > 0) {
  //    console.log(`不足コンテナ: ${missingContainers.length}`);
  //    missingContainers.forEach(cat => {
 //       console.log(`  ✗ ${cat.name} - Container: ${cat.hasContainer ? '✓' : '✗'}, Counter: ${cat.hasCounter ? '✓' : '✗'}`);
 //     });
    }
    
    return { available: availableContainers, missing: missingContainers };
  }
  
  // 不足コンテナの動的生成
  function generateMissingContainers(missingContainers) {
    console.log('=== 不足コンテナ動的生成 ===');
    
    const sfwAccordion = document.getElementById('wm-accordion-sfw');
    const nsfwAccordion = document.getElementById('wm-accordion-nsfw');
    
    if (!sfwAccordion || !nsfwAccordion) {
      console.error('アコーディオン親要素が見つかりません');
      return;
    }
    
    missingContainers.forEach(cat => {
      const isNSFW = cat.name.includes('nsfw') || cat.name.includes('interaction-nsfw') || cat.name.includes('background-nsfw');
      const parentAccordion = isNSFW ? nsfwAccordion : sfwAccordion;
      
      // ラベル生成
      const labelMap = {
        'worldview': '世界観',
        'emotion-primary': '基本感情',
        'emotion-detail': '詳細感情',
        'mouth-state': '口の状態',
        'eye-state': '目の状態',
        'gaze': '視線方向',
        'pose-manga': '漫画ポーズ',
        'hand-gesture': '手のジェスチャー',
        'movement-action': '動作アクション',
        'props-light': '小物',
        'effect-manga': '漫画エフェクト',
        'camera-view': 'カメラビュー',
        'camera-angle': 'カメラアングル',
        'interaction-sfw': 'インタラクション（SFW）',
        'interaction-nsfw': 'インタラクション（NSFW）',
        'background-nsfw': '背景（NSFW）',
        'negative-essential': 'ネガティブ（必須）',
        'negative-quality': 'ネガティブ（品質）',
        'negative-unwanted': 'ネガティブ（不要素）',
        'negative-face': 'ネガティブ（顔）',
        'negative-body': 'ネガティブ（身体）',
        'negative-style': 'ネガティブ（画風）',
        'negative-composition': 'ネガティブ（構図）',
        'negative-clothing': 'ネガティブ（服装）'
      };
      
      const label = labelMap[cat.name] || cat.name;
      
      // HTMLを生成
      const html = `
        <details class="wm-acc" data-cat="${cat.name}">
          <summary>${label} <span class="wm-count" id="wm-count-${cat.name}">0</span></summary>
          <div class="wm-items" id="wm-items-${cat.name}"></div>
        </details>
      `;
      
      // 挿入
      parentAccordion.insertAdjacentHTML('beforeend', html);
      console.log(`  ✓ ${cat.name} (${label}) コンテナを生成`);
    });
  }
  
  // 漫画カテゴリ専用初期化関数
  function initMangaCategories() {
    console.log('=== 漫画カテゴリ初期化開始 ===');
    
    if (mangaWordModeInitialized) {
      console.log('既に初期化済みです');
      return;
    }
    
    // 1. 辞書の完全性チェック
    const dictCheck = checkDictionaryCompleteness();
    
    // 2. HTMLコンテナのチェック
    const containerCheck = checkHTMLContainers();
    
    // 3. 不足コンテナがあれば生成
    if (containerCheck.missing.length > 0) {
      generateMissingContainers(containerCheck.missing);
    }
    
    // 4. 利用可能なカテゴリのみ初期化
    let totalInitialized = 0;
    dictCheck.available.forEach(cat => {
      const containerId = `wm-items-${cat.name}`;
      const countId = `wm-count-${cat.name}`;
      
      const container = document.getElementById(containerId);
      const counter = document.getElementById(countId);
      
      if (container && counter) {
        try {
          const dictData = cat.dict === 'SFW' ? window.SFW[cat.key] : window.NSFW[cat.key];
          
          if (dictData && dictData.length > 0) {
            // アイテム作成（既存のcreateWordModeItem関数を使用）
            if (typeof window.createWordModeItem === 'function') {
              container.innerHTML = dictData.map(item => window.createWordModeItem(item, cat.name)).join('');
            } else {
              // フォールバック：シンプルなHTML生成
              container.innerHTML = dictData.map(item => {
                const tag = item.tag || '';
                const label = item.label || item.tag || '';
                return `
                  <button class="wm-item" type="button" data-en="${tag}" data-jp="${label}" data-cat="${cat.name}">
                    <span class="wm-jp">${label}</span>
                    <small class="wm-en">${tag}</small>
                    <span class="wm-actions">
                      <button class="wm-copy-en" type="button" title="英語のみコピー">EN</button>
                      <button class="wm-copy-both" type="button" title="日本語(英語)コピー">BOTH</button>
                    </span>
                  </button>
                `;
              }).join('');
            }
            
            counter.textContent = dictData.length;
            totalInitialized += dictData.length;
            console.log(`  ✓ ${cat.name}: ${dictData.length}件初期化`);
          }
        } catch (error) {
          console.warn(`${cat.name} の初期化でエラー:`, error);
        }
      }
    });
    
    console.log(`=== 漫画カテゴリ初期化完了: ${totalInitialized}アイテム ===`);
    mangaWordModeInitialized = true;
    
    // 検索統計を更新
    setTimeout(() => {
      if (typeof window.updateSearchStats === 'function') {
        const totalItems = document.querySelectorAll('#panelWordMode .wm-item').length;
        window.updateSearchStats(totalItems, totalItems);
      }
    }, 100);
  }
  
  // 初期化タイミングの制御
  function scheduleInitialization() {
    // 複数のタイミングで初期化を試行
    const initTriggers = [
      // 1. DOM読み込み完了後
      () => {
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initMangaCategories);
        } else {
          setTimeout(initMangaCategories, 100);
        }
      },
      
      // 2. 辞書読み込み完了後
      () => {
        const checkDictionaries = () => {
          if (window.SFW && window.NSFW) {
            initMangaCategories();
          } else {
            setTimeout(checkDictionaries, 500);
          }
        };
        setTimeout(checkDictionaries, 1000);
      },
      
      // 3. 単語モードタブが初回クリックされた時
      () => {
        const wordTab = document.querySelector('.tab[data-mode="word"]');
        if (wordTab) {
          const originalClick = () => {
            setTimeout(initMangaCategories, 200);
            wordTab.removeEventListener('click', originalClick);
          };
          wordTab.addEventListener('click', originalClick);
        }
      }
    ];
    
    // すべてのトリガーを設定
    initTriggers.forEach((trigger, index) => {
      try {
        trigger();
      } catch (error) {
        console.warn(`初期化トリガー ${index} でエラー:`, error);
      }
    });
  }
  
  // グローバル関数として公開
  window.initMangaWordMode = initMangaCategories;
  window.checkMangaWordMode = function() {
    return {
      initialized: mangaWordModeInitialized,
      dictionary: checkDictionaryCompleteness(),
      containers: checkHTMLContainers()
    };
  };
  
  // 強制再初期化
  window.reinitMangaWordMode = function() {
    mangaWordModeInitialized = false;
    
    // 既存のアイテムをクリア
    Object.keys(MANGA_CATEGORY_MAPPING).forEach(categoryName => {
      const container = document.getElementById(`wm-items-${categoryName}`);
      const counter = document.getElementById(`wm-count-${categoryName}`);
      if (container) container.innerHTML = '';
      if (counter) counter.textContent = '0';
    });
    
    initMangaCategories();
  };
  
  // 初期化スケジュール実行
  scheduleInitialization();
  
  console.log('漫画カテゴリ単語モード統合スクリプトが読み込まれました');
  console.log('デバッグコマンド:');
  console.log('  window.checkMangaWordMode() - 状態確認');
  console.log('  window.reinitMangaWordMode() - 強制再初期化');
  
})();
</script>         


      
</body>
</html>
